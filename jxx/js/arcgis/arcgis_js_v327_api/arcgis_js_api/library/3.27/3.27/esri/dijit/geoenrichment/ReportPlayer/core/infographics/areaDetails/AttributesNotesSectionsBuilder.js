// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/infographics/areaDetails/AttributesNotesSectionsBuilder","dojo/_base/lang dojo/promise/all dojo/when ../../supportClasses/tableJson/TableJsonUtil ../../supportClasses/tableJson/TableJsonResizeUtil ./AreaDetailsLayouts ../../../dataProvider/supportClasses/attachments/AttributesUtil ../../sections/SectionTypes dojo/i18n!esri/nls/jsapi".split(" "),function(p,G,H,q,u,E,I,v,r){r=r.geoenrichment.dijit.ReportPlayer.AreaDetailsInfographic;var l={buildDataInfo:function(b){return H(l._calcBuildInfo(b),
function(a){if(!a)return null;var c,d=l._createAttributesSectionJsons(a.attributes,b.infographicJson,b.defaultCellStyle),e=l._createNotesSectionJsons(a.notes,b.infographicJson,b.defaultCellStyle);a.canFitOnSinglePage?d.length?e.length?(c=d[0],e=e[0].stack[0],e.style.spaceBefore=a.attributes.totalHeight,c.stack.push(e),c=[c]):c=d:c=e:(c=[],c=c.concat(d),c=c.concat(e),c.forEach(function(c){u.resizeTableJsonToFitWidth(c.stack[0],b.width);b.scaleToFitHeight&&u.resizeTableJsonToFitHeight(c.stack[0],a.contentHeight-
b.footerHeight)}));return c.length?{sectionJsons:c,stats:{numAttributesTotal:a.attributes.numTotal,numAttributesShown:a.attributes.numShown,numNotesTotal:a.notes.numTotal,numNotesShown:a.notes.numShown}}:null})},_calcBuildInfo:function(b){var a=b.attachmentsStore,c=b.infographicJson,d=b.currentFeatureIndex,e=b.titleHeight,k=b.minRowHeight,f=b.scaleToFitHeight,g=b.footerHeight,h=b.searchTextRe,w=b.forceSinglePage,t=b.width,J=b.height;if(!a)return null;a.setCurrentAnalysisAreaIndex&&a.setCurrentAnalysisAreaIndex(d);
return G([a.getAttributes(),a.getNotes()]).then(function(b){var a=b[0]||[],d=b[1]||[];c.attributesSectionJson||(a=[]);c.notesSectionJson||(d=[]);if(!a.length&&!d.length)return null;b=a.length;var r=0,K=d.length,p=0;h&&(a=a.filter(function(a){return h.test(a.alias)}),d=d.filter(function(a){return h.test(a.text)}));var r=a.length,p=d.length,m=a.length,x=d.length,y=c.attributesLayout===E.ATTRS_2COLUMNS,u=y?Math.round(a.length/2):a.length,v=(y?Math.round(a.length/2):a.length)+(c.showAttributesTitle?1:
0),D=d.length,F=D+(c.showNotesTitle?1:0),z=J-e,n=Math.max(k||q.DEFAULT_ROW_HEIGHT,z/(v+F)),A=m?c.showAttributesTitle?n:0:0,B=m?n:0,C=x?c.showNotesTitle?n:0:0,n=x?n:0;f||(m&&(c.showAttributesTitle&&(m=c.attributesSectionJson.stack[0].data.data[0])&&(A=m.style.height),m=c.attributesSectionJson.stack[0].data.data[c.showAttributesTitle?1:0])&&(B=m.style.height),x&&(c.showNotesTitle&&(m=c.notesSectionJson.stack[0].data.data[0])&&(C=m.style.height),m=c.notesSectionJson.stack[0].data.data[c.showNotesTitle?
1:0])&&(n=m.style.height));(x=w||A+B*u+C+n*D<=z+1)?(a=[{attrs:a,numRows:v}],d=[{notes:d,numRows:F}]):(a=l._splitByPages(a,A,B*(y?.5:1),z,g).map(function(a){return{attrs:a,numRows:(y?Math.round(a.length/2):a.length)+(c.showAttributesTitle?1:0)}}),d=l._splitByPages(d,C,n,z,g).map(function(a){return{notes:a,numRows:a.length+(c.showNotesTitle?1:0)}}));return{canFitOnSinglePage:x,contentHeight:z,attributes:{attrGroups:a,numColumns:y?4:2,titleRowH:A,dataRowH:B,width:t,numTotal:b,numShown:r,totalHeight:A+
B*u},notes:{noteGroups:d,numColumns:1,titleRowH:C,dataRowH:n,width:t,numTotal:K,numShown:p,totalHeight:C+n*D}}})},_splitByPages:function(b,a,c,d,e){var k=d-e,f=[],g,h=0;b.forEach(function(b){g||(g=[],f.push(g),h+=a);g.push(b);h+=c;h+c>k&&(g=null,h=0)});return f},_createAttributesSectionJsons:function(b,a,c){var d=l._getSourceSectionStyle(a.attributesSectionJson,a.showAttributesTitle);return b.attrGroups.map(function(e){function k(a,e,f){e=e||0;q.modifyTableJson(g,h,0+e,{text:a?a.alias:"",cellStyle:l._getCellStyle(!1,
0+e,f,d,c),height:b.dataRowH});q.modifyTableJson(g,h,1+e,{text:I.formatAttributeValue(a),cellStyle:l._getCellStyle(!1,1+e,f,d,c)})}var f=e.attrs;if(!f.length)return null;var g=q.createTable({numColumns:b.numColumns,numRows:e.numRows,style:{width:b.width},useDefaultHeaderTheme:!1}),h=0;e=a.attributesLayout===E.ATTRS_2COLUMNS;a.showAttributesTitle&&(q.modifyTableJson(g,h,0,{text:d.title||r.attributes,columnSpan:b.numColumns,cellStyle:l._getCellStyle(!0,0,-1,d,c),height:b.titleRowH}),h++);for(var w=
0,t=0;t<f.length;t++){var p=f[t];k(p,0,w);e&&(p=f[++t],k(p,b.numColumns/2,w));h++;w++}return{type:v.INFOGRAPHIC_ATTRIBUTES,stack:[g]}}).filter(function(a){return!!a})},_createNotesSectionJsons:function(b,a,c){var d=l._getSourceSectionStyle(a.notesSectionJson,a.showNotesTitle);return b.noteGroups.map(function(e){var k=e.notes;if(!k.length)return null;var f=q.createTable({numColumns:b.numColumns,numRows:e.numRows,style:{width:b.width},useDefaultHeaderTheme:!1}),g=0;a.showNotesTitle&&(q.modifyTableJson(f,
g,0,{text:d.title||r.notes,cellStyle:l._getCellStyle(!0,0,-1,d,c),height:b.titleRowH}),g++);var h=0;k.forEach(function(a){q.modifyTableJson(f,g,0,{text:a.text,cellStyle:l._getCellStyle(!1,0,h,d,c),height:b.dataRowH});g++;h++});return{type:v.INFOGRAPHIC_NOTES,stack:[f]}}).filter(function(a){return!!a})},_getSourceSectionStyle:function(b,a){var c={titleStyle:null,title:null};if(b){b=b.stack[0];var d=b.data.columns[0].field,e=0;a&&(a=b.data.data[e++])&&(c.titleStyle=a.style.fields[d],c.title=a[d]);for(var k=
0;b.data.data[e];){var f=b.data.data[e++];b.data.columns.forEach(function(a,b){c["row"+k+"_column"+b]=f.style.fields[a.field]});k++}}return c},_getCellStyle:function(b,a,c,d,e){var k=0!==c%2,f=0!==a%2;b?c=d.titleStyle:(c=d["row"+c+"_column"+a])||(c=k?d["row1_column"+a]||(f?d.row1_column1:d.row1_column0)||d.row1_column0:d["row0_column"+a]||(f?d.row0_column1:d.row0_column0)||d.row0_column0);a=p.mixin({verticalAlign:"middle",horizontalAlign:f?"right":void 0,horizontalPadding:b||0<a?5:20},e);b&&(a.fontSize*=
1.2);p.mixin(a,c);return a}};return l});