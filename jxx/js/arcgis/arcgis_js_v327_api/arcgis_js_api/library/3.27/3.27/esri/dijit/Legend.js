// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
require({cache:{"dojo/debounce":function(){define([],function(){return function(q,y){var l;return function(){l&&clearTimeout(l);var f=this,n=arguments;l=setTimeout(function(){q.apply(f,n)},y)}}})},"esri/numberUtils":function(){define(["dojo/has","dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(q,y,l,f){var n=function(f,h){return f-h},z={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(f){var h=String(f),k=h.match(z._reNumber);f={integer:0,fractional:0};k&&k[1]?(f.integer=k[1].split("").length,
f.fractional=k[3]?k[3].split("").length:0):-1<h.toLowerCase().indexOf("e")&&(k=h.split("e"),h=k[0],k=k[1],h&&k&&(h=Number(h),k=Number(k),(f=0<k)||(k=Math.abs(k)),h=z.getDigits(h),f?(h.integer+=k,h.fractional=k>h.fractional?0:h.fractional-k):(h.fractional+=k,h.integer=k>h.integer?1:h.integer-k),f=h));return f},getFixedNumbers:function(f,h){var k;k=Number(f.toFixed(h));k<f?f=k+1/Math.pow(10,h):(f=k,k-=1/Math.pow(10,h));k=Number(k.toFixed(h));f=Number(f.toFixed(h));return[k,f]},getPctChange:function(f,
h,k,l){var n={prev:null,next:null},t;null!=k&&(t=f-k,n.prev=Math.floor(Math.abs(100*(h-k-t)/t)));null!=l&&(t=l-f,n.next=Math.floor(Math.abs(100*(l-h-t)/t)));return n},round:function(f,h){f=f.slice(0);var k,l,t,q,y,A,d,w,v=h&&null!=h.tolerance?h.tolerance:2,r=h&&h.indexes,N=h&&null!=h.strictBounds?h.strictBounds:!1;if(r)r.sort(n);else for(r=[],y=0;y<f.length;y++)r.push(y);for(y=0;y<r.length;y++)if(w=r[y],h=f[w],k=0===w?null:f[w-1],l=w===f.length-1?null:f[w+1],t=z.getDigits(h),t=t.fractional){A=0;for(d=
!1;A<=t&&!d;)q=z.getFixedNumbers(h,A),q=N&&0===y?q[1]:q[0],d=z.hasMinimalChange(h,q,k,l,v),A++;d&&(f[w]=q)}return f},hasMinimalChange:function(f,h,k,l,n){f=z.getPctChange(f,h,k,l);h=null==f.prev||f.prev<=n;k=null==f.next||f.next<=n;return h&&k||f.prev+f.next<=2*n},_reAllZeros:new RegExp("\\"+l.decimal+"0+$","g"),_reSomeZeros:/(\d)0*$/g,format:function(f,h){h=h||{places:20,round:-1};(f=y.format(f,h))&&(f=f.replace(z._reSomeZeros,"$1").replace(z._reAllZeros,""));return f}};q("extend-esri")&&(f.numberUtils=
z);return z})},"esri/renderers/utils":function(){define("dojo/_base/lang dojo/_base/array dojo/has dojo/date/locale ../kernel ../numberUtils ../Color dojo/i18n!dojo/cldr/nls/gregorian".split(" "),function(q,y,l,f,n,z,t,h){function k(d){return d&&y.map(d,function(d){return new t(d)})}function R(d,f,h){var r="";0===f?r=G.lt+" ":f===h&&(r=G.gt+" ");return r+d}var D={},G={lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e",pct:"%"},O={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},A={millisecond:{dateOptions:{formatLength:"long"},
timeOptions:{formatLength:"medium"}},second:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"medium"}},minute:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},hour:{dateOptions:{formatLength:"long"},timeOptions:{formatLength:"short"}},day:{selector:"date",dateOptions:{formatLength:"long"}},month:{selector:"date",dateOptions:{formatLength:"long"}},year:{selector:"date",dateOptions:{selector:"year"}}},d={formatLength:"short",fullYear:!0},w={formatLength:"short"};q.mixin(D,
{timelineDateFormatOptions:{selector:"date",dateOptions:{formatLength:"short",fullYear:!0}},formatDate:function(v,r){var l=[];null==v||v instanceof Date||(v=new Date(v));r=r||{};r=q.mixin({},r);var k=r.selector?r.selector.toLowerCase():null,C=!k||-1<k.indexOf("time"),k=!k||-1<k.indexOf("date");C&&(r.timeOptions=r.timeOptions||w,r.timeOptions&&(r.timeOptions=q.mixin({},r.timeOptions),r.timeOptions.selector=r.timeOptions.selector||"time",l.push(r.timeOptions)));k&&(r.dateOptions=r.dateOptions||d,r.dateOptions&&
(r.dateOptions=q.mixin({},r.dateOptions),r.dateOptions.selector=r.dateOptions.selector||"date",l.push(r.dateOptions)));l&&l.length?(l=y.map(l,function(d){return f.format(v,d)}),r=1==l.length?l[0]:h["dateTimeFormat-medium"].replace(/\'/g,"").replace(/\{(\d+)\}/g,function(d,f){return l[f]})):r=f.format(v);return r},createColorStops:function(d){var f=d.values,v=d.colors,l=d.labelIndexes,k=d.isDate,h=d.dateFormatOptions;d=[];return d=y.map(f,function(d,r){var C=null;if(!l||-1<y.indexOf(l,r)){var n;(n=
k?D.formatDate(d,h):z.format(d))&&(C=R(n,r,f.length-1))}return{value:d,color:v[r],label:C}})},updateColorStops:function(d){var f=d.stops,v=d.changes,l=d.isDate,k=d.dateFormatOptions,h=[],n,q=y.map(f,function(d){return d.value});y.forEach(v,function(d){h.push(d.index);q[d.index]=d.value});n=z.round(q,{indexes:h});y.forEach(f,function(d,r){d.value=q[r];if(null!=d.label){var v,h=null;(v=l?D.formatDate(n[r],k):z.format(n[r]))&&(h=R(v,r,f.length-1));d.label=h}})},createClassBreakLabel:function(d){var f=
d.minValue,v=d.maxValue,l=d.isFirstBreak?"":G.gt+" ";d="percent-of-total"===d.normalizationType?G.pct:"";f=null==f?"":z.format(f);v=null==v?"":z.format(v);return l+f+d+" \u2013 "+v+d},setLabelsForClassBreaks:function(d){var f=d.classBreaks,v=d.classificationMethod,l=d.normalizationType,h=[];f&&f.length&&("standard-deviation"===v?console.log("setLabelsForClassBreaks: cannot set labels for class breaks generated using 'standard-deviation' method."):d.round?(h.push(f[0].minValue),y.forEach(f,function(d){h.push(d.maxValue)}),
h=z.round(h),y.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:0===f?h[0]:h[f],maxValue:h[f+1],isFirstBreak:0===f,normalizationType:l})})):y.forEach(f,function(d,f){d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===f,normalizationType:l})}))},updateClassBreak:function(d){var f=d.classBreaks,l=d.normalizationType,h=d.change,k=h.index,h=h.value,v=-1,n=-1,q=f.length;"standard-deviation"===d.classificationMethod?console.log("updateClassBreak: cannot update labels for class breaks generated using 'standard-deviation' method."):
(0===k?v=k:k===q?n=k-1:(n=k-1,v=k),-1<v&&v<q&&(d=f[v],d.minValue=h,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===v,normalizationType:l})),-1<n&&n<q&&(d=f[n],d.maxValue=h,d.label=D.createClassBreakLabel({minValue:d.minValue,maxValue:d.maxValue,isFirstBreak:0===n,normalizationType:l})))},calculateDateFormatInterval:function(d){var f,h,l=d.length,k,v,n,q,w,A,t=Infinity,z;d=y.map(d,function(d){return new Date(d)});for(f=0;f<l-1;f++){k=d[f];n=[];w=Infinity;A=
"";for(h=f+1;h<l;h++)v=d[h],v=k.getFullYear()!==v.getFullYear()&&"year"||k.getMonth()!==v.getMonth()&&"month"||k.getDate()!==v.getDate()&&"day"||k.getHours()!==v.getHours()&&"hour"||k.getMinutes()!==v.getMinutes()&&"minute"||k.getSeconds()!==v.getSeconds()&&"second"||"millisecond",q=O[v],q<w&&(w=q,A=v),n.push(v);w<t&&(t=w,z=A)}return z},createUniqueValueLabel:function(d){var f=d.value,h=d.fieldInfo,l=d.domain;d=d.dateFormatInterval;var k=String(f);(l=l&&l.codedValues?l.getName(f):null)?k=l:"number"===
typeof f&&(k=h&&"esriFieldTypeDate"===h.type?D.formatDate(f,d&&A[d]):z.format(f));return k},cloneColorInfo:function(d){var f;d&&(f=q.mixin({},d),f.colors=k(f.colors),f.stops=f.stops&&y.map(f.stops,function(d){d=q.mixin({},d);d.color&&(d.color=new t(d.color));return d}),f.legendOptions&&(f.legendOptions=q.mixin({},f.legendOptions)));return f},cloneOpacityInfo:function(d){var f;if(d){f=q.mixin({},d);if(d=f.opacityValues)f.opacityValues=d.slice(0);if(d=f.stops)f.stops=y.map(d,function(d){return q.mixin({},
d)});if(d=f.legendOptions)f.legendOptions=q.mixin({},d)}return f},cloneSizeInfo:function(d){var f;d&&(f=q.mixin({},d),f.stops&&(f.stops=y.map(f.stops,function(d){return q.mixin({},d)})),(d=f.minSize)&&"object"===typeof d&&(f.minSize=D.cloneSizeInfo(d)),(d=f.maxSize)&&"object"===typeof d&&(f.maxSize=D.cloneSizeInfo(d)),d=f.legendOptions)&&(f.legendOptions=q.mixin({},d),d=d.customValues)&&(f.legendOptions.customValues=d.slice(0));return f},getClassCodesForRelationship:function(){return q.clone({2:["L",
"H"],3:["L","M","H"],4:["L","M1","M2","H"]})},getClassValuesForRelationship:function(){return q.clone({2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]})}});l("extend-esri")&&q.setObject("renderer.utils",D,n);return D})},"*noref":1}});
define("esri/dijit/Legend","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/debounce dojo/has dojo/sniff dojo/Deferred dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dojo/dom-class dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/utils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/utils ../symbols/jsonUtils ../renderers/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),function(q,
y,l,f,n,z,t,h,k,R,D,G,O,A,d,w,v,r,N,I,C,Z,T,S,J,E,K,ia,ja,ka,la,ma,na,U,oa,aa,V,ba,ca,P,da,ea,W){var fa=K.getClassValuesForRelationship(),ga={defaultShape:{type:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15"},stroke:{width:1,color:"#555555"}},X={HH:315,HL:45,LL:135,LH:225},F=y([ea,r],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,_preserveCacheOnDestroy:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,transparencyRampColor:new t([64,64,64]),
defaultText:"Aa",sizeRampLightColor:new t([255,255,255]),sizeRampDarkColor:new t([128,128,128]),layerConnects:[],gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){l.mixin(this,W.widgets.legend);this._i18n=W.widgets.legend;a=a||{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?
!1:!0,this._preserveCacheOnDestroy=a.preserveCacheOnDestroy?!0:!1,this.arrangement=a.arrangement===F.ALIGN_RIGHT?F.ALIGN_RIGHT:F.ALIGN_LEFT,this.arrangement===F.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[],this.hideLayersInLegend={},this.refresh=h(this.refresh,0)):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);
var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],q.locale&&-1!==q.locale.indexOf(c)&&(-1!==q.locale.indexOf("-")?-1!==q.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},startup:function(){this.inherited(arguments);this._initialize();
9>k("ie")&&(this._repaintItems=l.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeCachedLegendResponses();this._removeHoverHandlers();this.inherited(arguments)},_removeCachedLegendResponses:function(){this._preserveCacheOnDestroy||f.forEach(this.layers,function(a){delete a.legendResponse})},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&
(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)d.destroy(this.domNode.children[a]);
this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&(this.layers=[],f.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(this.hideLayersInLegend[a.layer.id]=a.hideLayers,this._addSubLayersToHide(a)):this.hideLayersInLegend[a.layer.id]=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),
a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];f.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var g;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&(g=c.getLayers(),f.forEach(g,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==
c.declaredClass&&(g=c.getFeatureLayers(),f.forEach(g,function(a){b.push(a.id)},this))},this);f.forEach(this.map.graphicsLayerIds,function(c){var g=this.map.getLayer(c);-1==f.indexOf(a,c)&&-1==f.indexOf(b,c)&&this._isSupportedLayerType(g)&&this._isLayerDrawingEnabled(g)&&(g.arcgisProps&&g.arcgisProps.title&&(g._titleForLegend=g.arcgisProps.title),this.layers.push(g))},this)}this._createLegend()},_isLayerDrawingEnabled:function(a){return a&&(a._params&&a._params.drawMode||a.isFeatureReductionActive&&
a.isFeatureReductionActive())},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=n.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=n.connect(this.map,"onLayerAdd",this,"_updateAllMapLayers"),this._olrConnect=n.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=n.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),f.forEach(this.layers,function(a){var b={};
b.oarcConnect=n.connect(a,"onFeatureReductionRendererChange",this,"_refreshLayers");b.oaicConnect=n.connect(a,"onFeatureReductionChange",this,"_refreshLayers");b.ovcConnect=n.connect(a,"onVisibilityChange",this,"_refreshLayers");b.oocConnect=n.connect(a,"onOpacityChange",this,"_refreshLayers");b.oscConnect=n.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(b.odcConnect=n.connect(a,"_onDynamicLayersChange",
l.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(b.oirConnect=n.connect(a,"onRenderingChange",l.partial(this._updateImageServiceLayers,this,a)),b.oivrConnect=n.connect(a,"onRendererChange",l.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(b.oivrConnect=n.connect(a,"onRendererChange",l.hitch(this,"_refreshLayers")));this.layerConnects[a.id]=b},this))},_deactivate:function(){this._ozeConnect&&
n.disconnect(this._ozeConnect);this._olaConnect&&n.disconnect(this._olaConnect);this._olroConnect&&n.disconnect(this._olroConnect);this._olrConnect&&n.disconnect(this._olrConnect);f.forEach(this.layers,function(a){a=this.layerConnects[a.id]||{};a.oarcConnect&&n.disconnect(a.oarcConnect);a.oaicConnect&&n.disconnect(a.oaicConnect);a.ovcConnect&&n.disconnect(a.ovcConnect);a.oocConnect&&n.disconnect(a.oocConnect);a.oscConnect&&n.disconnect(a.oscConnect);a.odcConnect&&n.disconnect(a.odcConnect);a.oirConnect&&
n.disconnect(a.oirConnect);a.oivrConnect&&n.disconnect(a.oivrConnect)},this);this.layerConnects=[]},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_updateAllMapLayers:function(){this.layers=[];f.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);f.forEach(this.map.graphicsLayerIds,
function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this._isLayerDrawingEnabled(a)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1,b=!1;w.set(this.domNode,"position","relative");d.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+"..."},this.domNode);var c=[];f.forEach(this.layers,function(e){if("esri.layers.KMLLayer"==e.declaredClass||"esri.layers.GeoRSSLayer"==e.declaredClass){var g;e.loaded?("esri.layers.KMLLayer"==
e.declaredClass?g=e.getLayers():"esri.layers.GeoRSSLayer"==e.declaredClass&&(g=e.getFeatureLayers(),this.hideLayersInLegend[e.id]&&(g=f.filter(g,function(a){return-1==f.indexOf(this.hideLayersInLegend[e.id],a.id)},this))),f.forEach(g,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&e._titleForLegend&&(a._titleForLegend=e._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==
a.geometryType&&(a._titleForLegend+=this.NLS_areas),c.push(a))},this)):n.connect(e,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===e.declaredClass)if(!e.loaded)n.connect(e,"onLoad",l.hitch(this,function(){this.refresh(this.layerInfos)}));else{if((!this._respectVisibility||this._respectVisibility&&e.visible)&&0<e.layerInfos.length&&f.some(e.layerInfos,function(a){return a.legendURL})){var B=!1;f.forEach(e.layerInfos,function(b){if(b.legendURL&&-1<
f.indexOf(e.visibleLayers,b.name)){B||(d.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(e._titleForLegend||e.name||e.id)+"\x3c/span\x3e"},this.domNode),B=!0);var c;b=b.legendURL;if(e.customParameters||e.customLayerParameters){var g=l.clone(e.customParameters||{});l.mixin(g,e.customLayerParameters||{});for(c in g)b+=(-1===b.indexOf("?")?"?":"\x26")+c+"\x3d"+g[c]}d.create("div",{innerHTML:"\x3cimg src\x3d'"+b+"'/\x3e"},this.domNode);a=!0}},this)}}else"esri.layers.WFSLayer"!==
e.declaredClass||e.renderer?c.push(e):(g=d.create("div",{id:this.id+"_"+e.id,"class":"esriLegendService"}),d.create("span",{innerHTML:this._getServiceTitle(e),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},g))))),d.place(g,this.id,"first"),g=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),g=d.create("tbody",{},g),"esriGeometryComplex"===e.geometryType?(this._buildRow_Renderer(e,
e._pointSymbol,null,this.NLS_points,null,g),this._buildRow_Renderer(e,e._lineSymbol,null,this.NLS_lines,null,g),this._buildRow_Renderer(e,e._polygonSymbol,null,this.NLS_areas,null,g)):"esriGeometryPoint"===e.geometryType?this._buildRow_Renderer(e,e._pointSymbol,null,"",null,g):"esriGeometryPolyline"===e.geometryType?this._buildRow_Renderer(e,e._lineSymbol,null,"",null,g):"esriGeometryPolygon"===e.geometryType&&this._buildRow_Renderer(e,e._polygonSymbol,null,"",null,g),b=!0)},this);var g=[];f.forEach(c,
function(a){if(!a.loaded)var b=n.connect(a,"onLoad",this,function(a){n.disconnect(b);b=null;this.refresh()});else if((!this._respectVisibility||this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var c=d.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});d.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},d.create("tr",{},d.create("tbody",
{},d.create("table",{width:"95%"},c)))));d.place(c,this.id,"first");a.legendResponse||a.renderer&&"esri.renderer.StretchRenderer"!==a.renderer.declaredClass?this._createLegendForLayer(a):this.isHostedTileService(a)?this._getLayerInfos(a).then(l.hitch(this,function(a){this._createLegendForLayer(a)}),l.hitch(this,function(a){g.push(this._legendRequest(a))})):g.push(this._legendRequest(a))}},this);0!==g.length||a||b?(new G(g)).addCallback(l.hitch(this,function(c){a||b?A.byId(this.id+"_msg").innerHTML=
"":A.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()})):(A.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate())},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer||this.isHostedTileService(a)){var b=!1;if(a.legendResponse||this.isHostedTileService(a)){var c=a.dynamicLayerInfos||a.layerInfos;c&&c.length?f.forEach(c,function(c,e){this.hideLayersInLegend[a.id]&&-1!==f.indexOf(this.hideLayersInLegend[a.id],c.id)||(c=this._buildLegendItems(a,c,e),b=b||c)},
this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(w.set(A.byId(this.id+"_"+a.id),"display","block"),w.set(A.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):
this._legendRequestTools(a);n.connect(a,"onLoad",l.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var g=l.hitch(this,"_processLegendResponse"),e={f:"json"};a._params.dynamicLayers&&(e.dynamicLayers=O.stringify(this._createDynamicLayers(a)),"[{}]"===e.dynamicLayers&&(e.dynamicLayers="[]"));a._params.bandIds&&(e.bandIds=a._params.bandIds);a._params.renderingRule?
e.renderingRule=a._params.renderingRule:a.rasterFunctionInfos&&0<a.rasterFunctionInfos.length&&f.forEach(a.rasterFunctionInfos,function(a){a&&a.name&&"none"===a.name.toLowerCase()&&(e.renderingRule=O.stringify({rasterFunction:a.name}))});return S({url:b,content:e,callbackParamName:"callback",load:function(b,c){g(a,b,c)},error:T.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+
"?soapUrl\x3d"+window.escape(b);if(!k("ie")||8<k("ie"))b+="\x26returnbytes\x3dtrue";var c=l.hitch(this,"_processLegendResponse");return S({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,e){c(a,b,e)},error:T.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,A.byId(this.id+"_"+a.id)&&d.empty(A.byId(this.id+"_"+a.id)),d.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},d.create("td",{align:this._align},
d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},A.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+z.toJson(b))},_buildLegendItems:function(a,b,c){var g=!1,e=A.byId(this.id+"_"+a.id),p=b.parentLayerId;if(b.subLayerIds)a=d.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==p?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==p?e:A.byId(this.id+"_"+a.id+"_"+p+"_group")),d.create("td",
{innerHTML:C.encode(b.name),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(this._respectVisibility&&a.visibleLayers)if(c=a.dynamicLayerInfos||a.layerInfos)if(a._params&&a._params.layers){if(-1===f.indexOf(a.visibleLayers,b.id))return g}else{if(c=this._getReallyVisibleLayers(c,a.visibleLayers),-1===f.indexOf(c,b.id))return g}else if(-1===f.indexOf(a.visibleLayers,b.id))return g;e=d.create("div",{id:this.id+"_"+a.id+
"_"+b.id,style:{display:"none"},"class":-1<p?this._legendAlign:""},-1==p?e:A.byId(this.id+"_"+a.id+"_"+p+"_group"));d.create("td",{innerHTML:C.encode(b.name)||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%","class":"esriLegendLayerLabel"},e))));c=a.dynamicLayerInfos||a.layerInfos;p=!1;c&&c.length&&(p=f.some(c,function(a){return!!a.drawingInfo}));if(a.legendResponse)g=g||this._buildLegendItems_Tools(a,b,e);else if(a.renderer||p)g=g||this._buildLegendItems_Renderer(a,
b,e)}return g},_getReallyVisibleLayers:function(a,b){if(!a||!b||!b.length)return[];var c=[],g=[],e;for(e=0;e<a.length;e++)if(a[e].subLayerIds){if(-1===f.indexOf(b,a[e].id)||-1<f.indexOf(g,a[e].id))g=g.concat(a[e].subLayerIds)}else-1<f.indexOf(b,a[e].id)&&-1===f.indexOf(g,a[e].id)&&c.push(a[e].id);return c},_buildLegendItems_Tools:function(a,b,c){var g=b.parentLayerId,e=this.map.getScale(),p=!1,B=function(a,b){var c,e;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(e=0;e<b.dynamicLayerInfos[e].length;e++){if(b.dynamicLayerInfos[e].mapLayerId==
a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,b,e)){var Y=!0;if(this._respectCurrentMapScale&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass)){var u=this._getEffectiveScale(a,b);if(u.minScale&&u.minScale<e||u.maxScale&&u.maxScale>e)Y=!1}if(Y){var e=B(a.legendResponse.layers,b),x=e.legendType,m=e.layerType,h=e.legend;
if(h){"esri.layers.ArcGISImageServiceLayer"!==a.declaredClass&&this._sanitizeLegendResponse(a,e,b);c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var l=d.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);var k=[];f.forEach(h,function(c){if(!(10.1<=a.version&&!c.values&&1<h.length)||!a._hideDefaultSymbol&&"\x3call other values\x3e"!==c.label&&(c.label||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version||
"Raster Layer"===m)){var e=c.label;if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)p=!0,e&&-1!==f.indexOf(k,e)||(k.push(e),this._buildRow_Tools(c,l,a,b.id,x))}},this)}}}p&&(w.set(A.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<g&&(w.set(A.byId(this.id+"_"+a.id+"_"+g+"_group"),"display","block"),this._findParentGroup(a.id,a,g)));return p},_getLayerInfos:function(a){var b=new D,c=a.dynamicLayerInfos||a.layerInfos;if(c&&c.length)if(f.some(c,function(a){return!!a.drawingInfo}))b.resolve(a);
else{var g=a.url,e=g.indexOf("?"),g=-1==e?g+"/layers":g.substring(0,e)+"/layers"+g.substring(e,g.length);S({url:g,content:{f:"json"},callbackParamName:"callback",load:function(e,g){e.layers?(f.forEach(c,function(a){var b=f.filter(e.layers,function(b){return a.source?b.id===a.source.mapLayerId:b.id===a.id});b&&b[0]&&b[0].drawingInfo&&(a.drawingInfo=b[0].drawingInfo,a.fields=b[0].fields)}),b.resolve(a)):b.reject(a)},error:function(c){b.reject(a)}})}return b},_sanitizeLegendResponse:function(a,b,c){var g=
b.legend;if(10.1<=a.version&&1<g.length&&!b._sanitized){a=l.getObject("layerDefinition.drawingInfo.renderer",!1,c);var e,d;a||(a=l.getObject("drawingInfo.renderer",!1,c));f.some(g,function(a){if(a.values)return!0})&&f.some(g,function(a,b){a.values||(d=b,e=a);return!!e});a?"uniqueValue"===a.type?e&&(g.splice(d,1),g.push(e)):"classBreaks"===a.type&&(e&&g.splice(d,1),g.reverse(),e&&g.push(e)):e&&(g.splice(d,1),g.push(e));b._sanitized=!0}},_buildRow_Tools:function(a,b,c,g,e){var f=d.create("tr",{},b),
B;this.alignRight?(b=d.create("td",{align:this._isRightToLeft?"left":"right"},f),B=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(B=d.create("td",{width:35,align:"center"},f),b=d.create("td",{},f));f=a.url;(!k("ie")||9<=k("ie")||9>k("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+g+"/images/"+a.url,(g=c._getToken())&&(f+="?token\x3d"+g));g=d.create("img",
{src:f,border:0,style:"opacity:"+c.opacity},B);a=d.create("td",{innerHTML:C.encode(a.label),align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%",dir:"ltr"},b))));e&&"Stretched"===e&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass&&(a.style.verticalAlign="top",a.style.lineHeight="1",g.style.marginBottom="-1px",g.style.display="block",b.style.verticalAlign="top");9>k("ie")&&(g.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,
b,c){var g;a&&(g=(a=a.getVisualVariablesForType(b,c))&&a[0]);return g},_getVariables:function(a,b,c){a=[this._getVariable(a,"colorInfo",!1),this._getVariable(a,"opacityInfo",!1),this._getVariable(a,"sizeInfo",!1)];return b?f.filter(a,function(a){return!(!a||a.field!==b||a.normalizationField!=c)}):a},_getFieldAlias:function(a,b,c){var g=b.infoTemplate||(b.infoTemplates&&c&&b.infoTemplates[c.id]?b.infoTemplates[c.id].infoTemplate:null),g=g&&g.getFieldInfo&&g.getFieldInfo(a);a=l.isFunction(a)?null:this.getField(b,
a,c);b=g||a;c="";b&&(c=g&&g.label||a&&a.alias||b.name||b.fieldName);return c},_getDomainName:function(a,b,c,g){var e;a&&!l.isFunction(a)&&(e=(c=(a=this.getField(c,a,g))&&c.getDomain?c.getDomain(a.name):null)&&c.codedValues?c.getName(b):null);return e},_getRampTitle:function(a,b,c){var g,e=a.field,d=a.normalizationField,f=!1,h=!1,u=!1,e=l.isFunction(e)?null:e,d=l.isFunction(d)?null:d;if(a.legendOptions&&a.legendOptions.title)g=a.legendOptions.title;else if(a.valueExpressionTitle)g=a.valueExpressionTitle;
else{if(b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables){var x=b.renderer.authoringInfo.visualVariables;for(a=0;a<x.length;a++){var m=x[a];if("colorInfo"===m.type&&"ratio"===m.style){f=!0;break}else if("colorInfo"===m.type&&"percent"===m.style){h=!0;break}else if("colorInfo"===m.type&&"percentTotal"===m.style){u=!0;break}}}(f=u&&"showRatioPercentTotal"||h&&"showRatioPercent"||f&&"showRatio"||d&&"showNormField"||e&&"showField"||null)&&(g=J.substitute({field:e&&this._getFieldAlias(e,
b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===f?"${field}":this._i18n[f]))}return g},_getRendererTitle:function(a,b,c){var g;if(a){var e,d,f;"esri.renderer.ClassBreaksRenderer"===a.declaredClass&&(e=a.attributeField,d=a.normalizationField,f="percent-of-total"===a.normalizationType);e=l.isFunction(e)?null:e;d=l.isFunction(d)?null:d;a.legendOptions&&a.legendOptions.title?g=a.legendOptions.title:a.valueExpressionTitle?g=a.valueExpressionTitle:(a=d&&"showNormField"||(f?"showNormPct":null)||
e&&"showField"||null)&&(g=J.substitute({field:e&&this._getFieldAlias(e,b,c),normField:d&&this._getFieldAlias(d,b,c)},"showField"===a?"${field}":this._i18n[a]))}return g},_buildLegendItems_Renderer:function(a,b,c){var g=b.parentLayerId,e=this.map,p=e.getScale(),B,h=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,p)){var u,x,m,k,n,r,q,v,y;m="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:b&&b.drawingInfo?da.fromJson(l.clone(b.drawingInfo.renderer)):a.isFeatureReductionActive&&
a.isFeatureReductionActive()?a.getFeatureReductionRenderer():a.renderer;if("esri.renderer.ScaleDependentRenderer"===m.declaredClass&&(m=(e="zoom"===m.rangeType?m.getRendererInfoByZoom(e.getZoom()):m.getRendererInfoByScale(p))&&e.renderer,!m))return!1;y=m&&m.authoringInfo&&"relationship"===m.authoringInfo.type;var t=this._getVariables(m),z=f.filter(t,function(a){return!!a}).length,p=t[0],e=t[1],t=t[2],D,Q,E,F,L;p&&(k=this._getMedianColor(m,p),p.field&&(r=l.isFunction(p.field)?null:this.getField(a,
p.field,b)),D=!(p.legendOptions&&!1===p.legendOptions.showLegend));e&&(e.field&&(v=l.isFunction(e.field)?null:this.getField(a,e.field,b)),Q=!(e.legendOptions&&!1===e.legendOptions.showLegend));t&&(t.field&&(q=l.isFunction(t.field)?null:this.getField(a,t.field,b)),E=!(t.legendOptions&&!1===t.legendOptions.showLegend));if("esri.renderer.HeatmapRenderer"===m.declaredClass)B=h=!0,this._showHeatRamp(a,b,m,c);else if("esri.renderer.DotDensityRenderer"===m.declaredClass)B=h=!0,this._showDotDensityLegend(a,
b,m,c);else if("esri.renderer.TemporalRenderer"===m.declaredClass)B=h=!0,x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),u=d.create("tbody",{},x),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(x,a,b),m.latestObservationRenderer&&"esri.renderer.SimpleRenderer"===m.latestObservationRenderer.declaredClass&&this._buildRow_Renderer(a,m.latestObservationRenderer.symbol,k,C.encode(m.latestObservationRenderer.label)||this.NLS_currentObservations,null,u),
m.observationRenderer&&"esri.renderer.SimpleRenderer"===m.observationRenderer.declaredClass&&this._buildRow_Renderer(a,m.observationRenderer.symbol,k,C.encode(m.observationRenderer.label)||this.NLS_previousObservations,null,u);else if("esri.renderer.UniqueValueRenderer"===m.declaredClass){if(m.infos&&0<m.infos.length){B=h=!0;if(m.legendOptions&&m.legendOptions.title||m.valueExpressionTitle)x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),u=d.create("tbody",
{},x),z=m.legendOptions&&m.legendOptions.title?m.legendOptions.title:m.valueExpressionTitle,this._buildRow_Renderer(a,null,k,C.encode(z),null,u);x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);u=d.create("tbody",{},x);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(x,a,b);m.attributeField&&t&&this._addSubHeader(u,this._getFieldAlias(m.attributeField,a,b));if(y){var H=m.authoringInfo;L=H.focus;var z=H.numClasses,G=H.field1.field;x=H.field2.field;if(z&&
G&&x){var M=H.field1.normalizationField,H=H.field2.normalizationField,I=M&&this._i18n.showNormField||G&&"${field}",N=H&&this._i18n.showNormField||x&&"${field}",G=J.substitute({field:this._getFieldAlias(G,a,b),normField:M&&this._getFieldAlias(M,a,b)},I);x=J.substitute({field:this._getFieldAlias(x,a,b),normField:H&&this._getFieldAlias(H,a,b)},N);M={shapeDescriptor:ga,rotation:this._getRotationAngleForFocus(L)||0};this._buildRow_Renderer(a,null,null,C.encode(G),null,u,null,M);M.rotation+=90;this._buildRow_Renderer(a,
null,null,C.encode(x),null,u,null,M);this._drawRelationshipLegend(c,{numClasses:z,focus:L,uvInfos:m.infos})}}else{var K=[];f.forEach(m.infos,function(c){var e=null;this._isLayerEditable(a)&&a.types&&(e=this._getTemplateFromTypes(a.types,c.value));var g=c.label;null==g&&(g=this._getDomainName(m.attributeField,c.value,a,b)||c.value);-1===f.indexOf(K,g)&&(K.push(g),this._buildRow_Renderer(a,c.symbol,k,C.encode(g),e,u))},this)}}L=!y&&this._displayDefaultSymbol(a,m,c)}else if("esri.renderer.ClassBreaksRenderer"===
m.declaredClass){if(m.infos&&0<m.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)B=h=!0,F=this._isUnclassedRenderer(m),p||1!==m.infos.length||(n=(n=m.infos[0])&&n.symbol),F||(x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),u=d.create("tbody",{},x),z=this._getRendererTitle(m,a,b),this._buildRow_Renderer(a,null,k,C.encode(z),null,u)),x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),u=d.create("tbody",
{},x),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(x,a,b),F&&t&&E||(y=m.infos.slice(0).reverse(),f.forEach(y,function(b){var c=b.label;null!=c||F||(c=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,k,C.encode(c),null,u)},this)),"esri.layers.ArcGISImageServiceVectorLayer"!==a.declaredClass||a.renderer.style!==U.STYLE_SCALAR&&a.renderer.style!==U.STYLE_SINGLE_ARROW||(this._buildRow_Renderer(a,m.defaultSymbol,null,"",null,u),a._hideDefaultSymbol=!0);F||(L=this._displayDefaultSymbol(a,
m,c))}else"esri.renderer.SimpleRenderer"===m.declaredClass&&(B=h=!0,x=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),u=d.create("tbody",{},x),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(x,a,b),n=null,this._isLayerEditable(a)&&a.templates&&0<a.templates.length&&(n=a.templates[0]),y=1<z?null:r&&D||v&&Q||q&&E,this._buildRow_Renderer(a,m.symbol,k,C.encode(y?this._getRampTitle(1<z?null:p||e||t,a,b):m.label),n,u),n=p?null:m.symbol,y&&(r=v=q=null));B&&
(p&&D&&(p.field||p.valueExpression)&&this._showGradientRamp(a,b,m,null,c,p,r,null,t&&E?!0:!1),t&&E&&(t.field||t.valueExpression)&&(B=p&&D||"esri.renderer.UniqueValueRenderer"===m.declaredClass?!1:!0,this._showSizeLegend(a,b,m,t,k,c,q,null,B)),e&&Q&&(e.field||e.valueExpression)&&this._showGradientRamp(a,b,m,n&&!n.url&&n.color?n.color:this.transparencyRampColor,c,e,v,null,!1));L||F&&!D&&!E&&!Q||(L=this._displayDefaultSymbol(a,m,c));h=h||L}h&&(w.set(A.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),
-1<g&&(w.set(A.byId(this.id+"_"+a.id+"_"+g+"_group"),"display","block"),this._findParentGroup(a.id,g)));return h},_isLayerEditable:function(a){return"function"===typeof a.isEditable&&a.isEditable()},_isUnclassedRenderer:function(a,b){var c;if("esri.renderer.ClassBreaksRenderer"===a.declaredClass&&a.infos&&1===a.infos.length){c=a.attributeField;var g=a.normalizationField;c=b?c===b:!!this._getVariables(a,c,g).length}return c},_displayDefaultSymbol:function(a,b,c){var g;!a._hideDefaultSymbol&&b.defaultSymbol&&
(g=!0,c=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),c=d.create("tbody",{},c),this._buildRow_Renderer(a,b.defaultSymbol,null,C.encode(b.defaultLabel)||"others",null,c));return g},_showGradientRamp:function(a,b,c,g,e,f,B,h,u){u=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(u?"":" esriLegendSubFragment")},e);e=d.create("tbody",{},u);(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(u,a,b,h);(B||f.valueExpression||
f.legendOptions&&f.legendOptions.title)&&this._addSubHeader(e,this._getRampTitle(f,a,b));B=f.field;var p;B&&(p=l.isFunction(B)?null:this.getField(a,B,b));(b=this._getRampStops(c,f,g,p&&"esriFieldTypeDate"===p.type))&&b.length&&this._drawGradientRamp(e,b,!0,a,this._getRampBorderColor(c),!!g)},_getMedianColor:function(a,b){var c,g;b.colors?(c=b.minDataValue,g=b.maxDataValue):b.stops&&(c=b.stops[0].value,g=b.stops[b.stops.length-1].value);return a.getColor(c+(g-c)/2,{colorInfo:b})},_getRampStops:function(a,
b,c,g){var e,d,h,k,u=!1;b.colors||b.opacityValues?(d=b.maxDataValue-b.minDataValue,e=f.map([0,.25,.5,.75,1],function(a){h=b.minDataValue+a*d;return Number(h.toFixed(6))}),this._checkPrecision(0,4,e)):b.stops&&(e=f.map(b.stops,function(a){return a.value}),(u=f.some(b.stops,function(a){return!!a.label}))&&(k=f.map(b.stops,function(a){return a.label})));var x=e[0],m,l;d=e[e.length-1]-x;return f.map(e,function(f,p){c?(m=new t(c.toRgba()),l=a.getOpacity(f,{opacityInfo:b}),null!=l&&(m.a=l)):m=a.getColor(f,
{colorInfo:b});var h="";if(u)h=k[p];else{var h=g?K.formatDate(f,K.timelineDateFormatOptions):E.format(f),B="";0===p?B=this._specialChars.lt+" ":p===e.length-1&&(B=this._specialChars.gt+" ");h=B+h}return{value:f,color:m,offset:1-(f-x)/d,label:h}},this).reverse()},_checkPrecision:function(a,b,c){var g=a+(b-a)/2,e=c[a],d=c[g],f=c[b],h=Math.floor(e),k=Math.floor(d),x=Math.floor(f);h===e&&x===f&&k!==d&&h!==k&&x!==k&&(c[g]=k);a+1!==g&&this._checkPrecision(a,g,c);g+1!==b&&this._checkPrecision(g,b,c)},_getRampBorderColor:function(a){var b;
if("esri.renderer.SimpleRenderer"===a.declaredClass)b=a.symbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawGradientRamp:function(a,b,c,g,e,h){var p=d.create("tr",{},a),l,u,x,m,n,r=b.length-1,q;m=0;this.alignRight?(a=d.create("td",{align:this._isRightToLeft?"left":"right"},p),l=d.create("td",{align:this._isRightToLeft?"left":"right",
width:this.gradientWidth},p)):(l=d.create("td",{width:this.gradientWidth,align:"center"},p),a=d.create("td",{},p));p=e&&0<e.a&&!(240<=e.r&&240<=e.g&&240<=e.b);u=d.create("div",{"class":p?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},l);l=d.create("div",{"class":"esriLegendColorRamp"+(h?" esriLegendTransparencyRamp":"")},u);h=w.get(l,"width");p&&(e=9>k("ie")?e.toHex():"rgba("+e.toRgba().join(",")+")",w.set(l,"border",this.colorRampBorder+" "+e));c?
(e=this.gradientHeight*r,w.set(l,"height",e+"px")):e=w.get(l,"height");w.set(u,"height",e+"px");p=N.createSurface(l,h,e);9>k("ie")&&(m=p.getEventSource(),w.set(m,"position","relative"),w.set(m.parentNode,"position","relative"),m=1);try{c&&f.forEach(b,function(a,b){a.offset=b/r}),n=p.createRect({x:-m,y:-m,width:h+m,height:e+m}),n.setFill({type:"linear",x1:0,y1:0,x2:0,y2:e,colors:b}).setStroke(null),p.createRect({width:h,height:e}).setFill(new t([255,255,255,1-g.opacity])).setStroke(null),this._surfaceItems.push(p)}catch(ha){p.clear(),
p.destroy()}f.forEach(b,function(a,c){a.label&&(q="top:"+100*a.offset+"%;",a="",0===c&&(a+=" esriLegendColorRampTickFirst"),c===b.length-1&&(a+=" esriLegendColorRampTickLast"),d.create("div",{"class":"esriLegendColorRampTick"+a,innerHTML:"\x26nbsp;",style:q},u))});x=d.create("div",{"class":"esriLegendColorRampLabels",style:{height:e+this.gradientHeight+"px"}},a);c?f.forEach(b,function(a){d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:C.encode(a.label)||"\x26nbsp;"},x)}):(d.create("div",
{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},x),d.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,style:"top: "+(e+this.gradientHeight-2*this.gradientHeight)+"px;"},x))},_showHeatRamp:function(a,b,c,g,e){var f,h=c.field;f=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g);g=d.create("tbody",{},f);(a._hoverLabel||a._hoverLabels||e)&&this._createHoverAction(f,a,b,e);(h=h&&this.getField(a,h,b))&&this._addSubHeader(g,this._getFieldAlias(h.name,
a,b));b=this._getHeatmapStops(c);b.length&&this._drawGradientRamp(g,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,g,e,d;b&&b[0]?(c=b.length-1,(a=b[0]&&null!=b[0].ratio)?(a=b[c])&&1!==a.ratio&&(b=b.slice(0),b.push({ratio:1,color:a.color}),c++):(g=b[0].value,e=b[c].value-g,b=f.map(b,function(a){return{color:a.color,ratio:(a.value-g)/e}}))):a&&a[0]&&(c=a.length-1,d=1/(a.length-1),b=f.map(a,function(a,b){return{color:a,ratio:b*d}}));b=f.map(b,function(a,b){var e="";0===b?e=
"Low":b===c&&(e="High");return{color:a.color,label:e,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,g){var e=c.legendOptions,h,k,n,u,x,m,r,q=this.dotDensitySwatchSize,t=Math.round(q/2);e&&(k=e.backgroundColor,n=e.outline,u=e.valueUnit,x=e.dotCoverage);x=(x||this.dotCoverage)/100;r=Math.round(q*q/Math.pow(c.dotSize,2)*x);g=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g);m=d.create("tbody",{},g);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(g,
a,b);this._addSubHeader(m,J.substitute({value:c.dotValue,unit:u||""},this.NLS_dotValue));f.forEach(c.fields,function(e){e=l.mixin({},e);e.numPoints=r;h=new aa(c._generateImageSrc(q,q,[e],{x:0,y:0},{x:q,y:q},k),n||c.outline,q,q);e=this.getField(a,e.name,b)||e;this._buildRow_Renderer(a,h,null,C.encode(this._getFieldAlias(e.name,a,b)),null,m,{type:"path",path:"M "+-t+","+-t+" L "+t+","+-t+" L "+t+","+t+" L "+-t+","+t+" L "+-t+","+-t+" E"})},this)},_showSizeLegend:function(a,b,c,g,e,f,h,k,u){var p=g.legendOptions,
p=p&&p.customValues;e=this._getSizeSymbol(c,e);if((!g.valueUnit||"unknown"===g.valueUnit)&&e&&(p||null!=g.minSize&&null!=g.maxSize&&null!=g.minDataValue&&null!=g.maxDataValue||g.stops&&!(1>=g.stops.length))){u=d.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"+(u?"":" esriLegendSubFragment")},f);f=d.create("tbody",{},u);(a._hoverLabel||a._hoverLabels||k)&&this._createHoverAction(u,a,b,k);(h||g.valueExpression||g.legendOptions&&g.legendOptions.title)&&this._addSubHeader(f,
this._getRampTitle(g,a,b));h=g.field;var m;k=l.isFunction(h);h&&(m=k?null:a.isFeatureReductionActive&&a.isFeatureReductionActive()?a.getFeatureReductionField(h):this.getField(a,h,b));b=m&&"esriFieldTypeDate"===m.type;var p=p||this._getDataValues(c,e,g,b),n,B=p.length-1;for(m=B;0<=m;m--)u=p[m],e=P.fromJson(e.toJson()),this._applySize(e,c,g,u),u=b?K.formatDate(u,K.timelineDateFormatOptions):E.format(u),n="",m===B?n=this._specialChars.gt+" ":0===m&&(n=h&&!k&&"cluster_count"===h.toLowerCase()&&1===p[m]?
"":this._specialChars.lt+" "),n="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+C.encode(n+u)+"\x3c/span\x3e",this._buildRow_Renderer(a,e,null,n,null,f)}},_getSizeSymbol:function(a,b){var c,g;if("esri.renderer.SimpleRenderer"===a.declaredClass)c=a.symbol;else if("esri.renderer.VectorFieldRenderer"===a.declaredClass)c=a.defaultSymbol;else if("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)c=a.infos[0].symbol,g=1<a.infos.length;if(c=c&&
-1!==c.type.indexOf("fillsymbol")?null:c)if(c=P.fromJson(c.toJson()),b||g)-1!==c.type.indexOf("linesymbol")?c.setColor(new t(this.sizeRampDarkColor)):(c.setColor(new t(this.sizeRampLightColor)),c.setOutline&&(a=new ba,a.setColor(new t(this.sizeRampDarkColor)),a.setWidth(1.5),c.setOutline(a)));return c},_getDataValues:function(a,b,c,g,e,d){e=null==e?5:e;d=null==d?20:d;var h=a.getSizeRangeAtScale(c,this.map.getScale());e=this._interpolateSizeRange(h,e);var p=this._getDataRange(c),k=f.map(e,function(a){return this._getDataValueFromSize(a,
p,h)},this);if(!g){var l,k=E.round(k);for(g=1;g<k.length-1;g++)if(l=this._roundDataValue(a,b,c,k[g],k[g-1],d))k[g]=l[0],e[g]=l[1]}return k},_getDataRange:function(a){var b=a.stops;return b?{min:b[0].value,max:b[b.length-1].value}:{min:a.minDataValue,max:a.maxDataValue}},_interpolateSizeRange:function(a,b){var c=a.minSize;a=(a.maxSize-c)/(b-1);var g,e=[];for(g=0;g<b;g++)e.push(c+a*g);return e},_getDataValueFromSize:function(a,b,c){var g=c.minSize;c=c.maxSize;var e=b.min;b=b.max;return a<=g?e:a>=c?
b:(a-g)/(c-g)*(b-e)+e},_roundDataValue:function(a,b,c,g,e,d){var f=this._getSize(b,a,c,g);e=this._getSize(b,a,c,e);var h,k=E.getDigits(g),p=k.integer,k=k.fractional,m,l,n,q,t,r,v,y,w,z,A;0<g&&1>g&&(h=Math.pow(10,k),g*=h,p=E.getDigits(g).integer);for(--p;0<=p&&(m=Math.pow(10,p),k=Math.floor(g/m)*m,m*=Math.ceil(g/m),null!=h&&(k/=h,m/=h),l=(k+m)/2,l=E.round([k,l,m],{indexes:[1]})[1],n=this._getSize(b,a,c,k),q=this._getSize(b,a,c,m),t=this._getSize(b,a,c,l),r=E.getPctChange(f,n,e,null),v=E.getPctChange(f,
q,e,null),y=E.getPctChange(f,t,e,null),w=r.prev<=d,z=v.prev<=d,w&&z&&(r.prev<=v.prev?(w=!0,z=!1):(z=!0,w=!1)),w?A=[k,n]:z?A=[m,q]:y.prev<=d&&(A=[l,t]),!A);p--);return A},_applySize:function(a,b,c,g){var e=a.type;b=this._getSize(a,b,c,g);switch(e){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":e=a.width;c=a.height;a.setHeight(b);a.setWidth(e/c*b);break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,
b,c,g){return b.getSize(g,{sizeInfo:c,scale:this.map.getScale(),shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,b,c,g,e,f,h,k){var p=!!k,l=d.create("tr",{},f),m;if(this.alignRight){if(f=d.create("td",{align:this._isRightToLeft?"left":"right"},l),b||p)m=d.create("td",{align:this._isRightToLeft?"left":"right",width:35},l)}else{if(b||p)m=d.create("td",{width:35,align:"center"},l);f=d.create("td",{},l)}var n=l=30,q;if(b)if("simplemarkersymbol"==b.type)l=Math.min(Math.max(l,
b.size+12),125),n=Math.min(Math.max(n,b.size+12),125);else if("picturemarkersymbol"==b.type)l=Math.min(Math.max(l,b.width),125),n=Math.min(b.height||n,125);else if("textsymbol"==b.type){var t,r;b.text||(t=b.text,r=!0,b.setText(this.defaultText));l=Math.min(Math.max(l,b.getWidth()+12),125);n=Math.min(Math.max(n,b.getHeight()+12),125);r&&b.setText(t)}if(b||p)q=d.create("div",{style:"width:"+l+"px;height:"+n+"px;"},m);J.isDefined(g)&&"number"===typeof g&&(g=""+g);d.create("td",{innerHTML:g||"",align:this._align},
d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},f))));if(b||p)a=this._drawSymbol(q,b,c,l,n,e,a,h,k),this._surfaceItems.push(a)},_addSubHeader:function(a,b){a=d.create("tr",{},a);a=d.create("td",{align:this._align,colspan:2},a);d.create("td",{innerHTML:C.encode(b)||"",align:this._align},d.create("tr",{},d.create("tbody",{},d.create("table",{width:"95%"},a))))},_drawSymbol:function(a,b,c,g,e,d,f,h,n){var p=b&&P.fromJson(b.toJson()),m=f.opacity;b=!!n;if(p)if(c&&p.setColor(new t(c.toRgba())),
"simplelinesymbol"===p.type||"cartographiclinesymbol"===p.type||"textsymbol"===p.type){if(!p.color)return;c=p.color.toRgba();c[3]*=m;p.color.setColor(c)}else"simplemarkersymbol"===p.type||"simplefillsymbol"===p.type?(p.color&&(c=p.color.toRgba(),c[3]*=m,p.color.setColor(c)),p.outline&&p.outline.color&&(c=p.outline.color.toRgba(),c[3]*=m,p.outline.color.setColor(c))):"picturemarkersymbol"===p.type&&(a.style.opacity=m,a.style.filter="alpha(opacity\x3d("+100*m+"))");a=N.createSurface(a,g,e);9>k("ie")&&
(c=a.getEventSource(),w.set(c,"position","relative"),w.set(c.parentNode,"position","relative"));d=b?n.shapeDescriptor:this._getDrawingToolShape(p,d)||P.getShapeDescriptors(p);var q,m=(c=d.defaultShape)&&"text"===c.type;try{m&&!c.text&&(c.text=this.defaultText),q=a.createShape(h||c).setFill(d.fill).setStroke(d.stroke),m&&q.setFont(d.font)}catch(ha){a.clear();a.destroy();return}var r=q.getBoundingBox();h=r.width;d=r.height;var m=-(r.x+h/2),u=-(r.y+d/2);c=a.getDimensions();m={dx:m+c.width/2,dy:u+c.height/
2};if(p&&"simplemarkersymbol"===p.type&&"path"===p.style)g=f._getScaleMatrix(r,p.size),q.applyTransform(I.scaleAt(g.xx,g.yy,{x:c.width/2,y:c.height/2}));else if(h>g||d>e)f=h/g>d/e,g=((f?g:e)-5)/(f?h:d),l.mixin(m,{xx:g,yy:g});q.applyTransform(m);b&&q.applyTransform(I.rotategAt(n.rotation,h/2,d/2));return a},_getDrawingToolShape:function(a,b){switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":b={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 Z"};break;case "esriFeatureEditToolTriangle":b=
{type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 Z"};break;case "esriFeatureEditToolRectangle":b={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"};break;case "esriFeatureEditToolCircle":b={type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":b={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:b,fill:a.getFill(),stroke:a.getStroke()}},_drawRelationshipLegend:function(a,b){var c=b.focus,d=b.numClasses,e=fa[d],f=!!c,h=Math.sqrt(Math.pow(75,
2)+Math.pow(75,2)),k={};b.uvInfos.forEach(function(a){k[a.value]={label:a.label,fill:this._getSymbolColor(a.symbol)}},this);b=[];for(var l=0;l<d;l++){for(var n=[],m=0;m<d;m++)n.push(k[e[l][m]].fill);b.push(n)}e=this._getRelationshipCornerLabels(c,k);a=this._drawRampLayout(a,e,h,f);a=N.createSurface(a,h,h);f||(a.rawNode.style.margin="-15px -15px -18px -15px");b=ca.create2DColorRamp({surface:a,colors:b,numClasses:d,size:75});d=(h-75)/2;h=(h-75)/2;b.applyTransform(I.translate(d,h));f&&b.applyTransform(I.rotategAt(this._getRotationAngleForFocus(c),
37.5,37.5));b=a.createGroup();e={width:1,color:"#555555"};l=a.defNode;this._createArrowMarker(l,"start");this._createArrowMarker(l,"end");l=b.createLine({x1:-10,y1:60,x2:-10,y2:15}).setStroke(e);e=b.createLine({x1:15,y1:85,x2:60,y2:85}).setStroke(e);this._setLineArrow(l.rawNode,"left",c);this._setLineArrow(e.rawNode,"right",c);b.applyTransform(I.translate(d,h));f&&b.applyTransform(I.rotategAt(-45,37.5,37.5));this._surfaceItems.push(a)},_drawRampLayout:function(a,b,c,g){var e=d.create("div",{style:{padding:"10px"}},
a);a=c+"px";c+="px";g?(g=d.create("div",{style:{display:"flex"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a,textAlign:"right"},innerHTML:b.left},g),e=d.create("div",{style:{display:"flex",flexDirection:"column",textAlign:"center"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.right},g),g=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.top},
e),g=d.create("div",{style:{height:c,width:c}},e),e=d.create("div",{class:"esriLegendRelationshipLabel",style:{alignSelf:"center",maxWidth:a},innerHTML:b.bottom},e)):(e=d.create("div",{style:{display:"table",color:"#555555"}},e),g=d.create("div",{style:{display:"table-row"}},e),c=d.create("div",{style:{display:"table-row"}},e),e=d.create("div",{style:{display:"table-row"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"bottom"},
innerHTML:b.left},g),d.create("div",{style:{display:"table-cell"}},g),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"bottom"},innerHTML:b.top},g),d.create("div",{style:{display:"table-cell"}},c),g=d.create("div",{style:{display:"table-cell"}},c),d.create("div",{style:{display:"table-cell"}},c),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"right",verticalAlign:"top"},
innerHTML:b.bottom},e),d.create("div",{style:{display:"table-cell"}},e),d.create("div",{class:"esriLegendRelationshipLabel",style:{display:"table-cell",maxWidth:a,textAlign:"left",verticalAlign:"top"},innerHTML:b.right},e));return g},_getSymbolColor:function(a){if(a)return"simplelinesymbol"===a.type||"simplemarkersymbol"===a.type&&(a.style===V.STYLE_X||a.style===V.STYLE_CROSS)?(a=a.getStroke())&&a.color:a.getFill()},_getRotationAngleForFocus:function(a){var b=X[a];a&&null==b&&(b=X.HH);return b},_setLineArrow:function(a,
b,c){var d=this.id+"_arrowStart",e=this.id+"_arrowEnd";b="left"===b;switch(c){case "HL":a.setAttribute(b?"marker-start":"marker-end","url(#"+(b?e:d)+")");break;case "LL":a.setAttribute("marker-start","url(#"+e+")");break;case "LH":a.setAttribute(b?"marker-end":"marker-start","url(#"+(b?d:e)+")");break;default:a.setAttribute("marker-end","url(#"+d+")")}},_createArrowMarker:function(a,b){var c="start"===b,d=this.id+(c?"_arrowStart":"_arrowEnd");b=c?"0,0 5,5 0,10":"5,0 0,5 5,10";var e=c?5:0,c=document.createElementNS("http://www.w3.org/2000/svg",
"marker");c.setAttribute("id",d);c.setAttribute("markerWidth","10");c.setAttribute("markerHeight","10");c.setAttribute("refX",e);c.setAttribute("refY","5");c.setAttribute("markerUnits","strokeWidth");c.setAttribute("orient","auto");d=document.createElementNS("http://www.w3.org/2000/svg","polyline");d.setAttribute("points",b);d.setAttribute("fill","none");d.setAttribute("stroke","#555555");d.setAttribute("stroke-width","1");c.appendChild(d);a.appendChild(c)},_getRelationshipCornerLabels:function(a,
b){var c=b.HH.label,d=b.LL.label,e=b.HL.label;b=b.LH.label;switch(a){case "HH":return{top:c,bottom:d,left:e,right:b};case "HL":return{top:e,bottom:b,left:d,right:c};case "LL":return{top:d,bottom:c,left:b,right:e};case "LH":return{top:b,bottom:e,left:c,right:d};default:return{top:c,bottom:d,left:e,right:b}}},_repaintItems:function(){f.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&
a.setFill(a.getFill())}catch(b){}a.children&&l.isArray(a.children)&&f.forEach(a.children,this._repaint,this)}},_createHoverAction:function(a,b,c,g){if(g=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||g)g=C.encode(g),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=n.connect(a,"onmousemove",l.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,w.set(A.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(l.hitch(this,
function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,A.byId(this.id+"_hoverLabel")){var e=A.byId(this.id+"_hoverLabel");e.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";w.set(e,"top",b+"px");w.set(e,"left",a+15+"px");w.set(e,"display","")}else d.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},g)),b.mouseOutHandler=
b.mouseOutHandler||{},b.mouseOutHandler[c.id]=n.connect(a,"onmouseout",l.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,w.set(A.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;f.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)n.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)n.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=
[],c;f.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJson();var e;a.layerDefinitions&&a.layerDefinitions[d.id]&&(e=a.layerDefinitions[d.id]);e&&(c.definitionExpression=e);var g;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(g=a.layerDrawingOptions[d.id]);g&&(c.drawingInfo=g.toJson());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&
0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,e=b.dynamicLayerInfos||b.layerInfos;for(d=0;d<e.length;d++)if(c==e[d].id){-1<e[d].parentLayerId&&(w.set(A.byId(this.id+"_"+a+"_"+e[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,e[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,g,h;for(g=0;g<e.length;g++)if(e[g].id===c&&e[g].subLayerIds)for(h=0;h<
e[g].subLayerIds.length;h++){var k=e[g].subLayerIds[h];-1===f.indexOf(d,k)&&(d.push(k),b(k,d))}}a.layer.layerInfos&&f.forEach(this.hideLayersInLegend[a.layer.id],function(c){b(c,this.hideLayersInLegend[a.layer.id])},this)},_isLayerInScale:function(a,b,c){var d,e=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var h,k;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==f.minScale&&a.tileInfo&&
(h=a.tileInfo.lods[0].scale),0==f.maxScale&&a.tileInfo&&(k=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(h=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,k=Math.max(a.maxScale,f.maxScale));if(0<h&&h<c||k>c)e=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)e=!1;return e},_getServiceTitle:function(a){var b=a._titleForLegend;b||(b=a.url,a.url?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+
1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:
this["NLS_"+a.vectorFieldPixelFilter.inputUnit],J.isDefined(a)&&(b+=" ("+a+")"));return C.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(J.isDefined(b.parentLayerId)){a=a.layerInfos;b=b.parentLayerId;var e;for(e=a.length-1;0<=e;e--)if(a[e].id==b)if(0==c&&0<a[e].minScale?c=a[e].minScale:0<c&&0==a[e].minScale||0<c&&0<a[e].minScale&&(c=Math.min(c,a[e].minScale)),d=Math.max(d||0,a[e].maxScale||0),-1<a[e].parentLayerId)b=a[e].parentLayerId;else break}return{minScale:c,maxScale:d}},
_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===
a.declaredClass||"esri.layers.WFSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1},isHostedTileService:function(a){var b=/(https?:)?\/\/services.*\.arcgis\.com/i;return"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass&&b.test(a.url)?!0:!1},getField:function(a,b,c){if(a.getField)return a.getField(b);if(c&&c.fields){var d;f.forEach(c.fields,function(a){a.name===b&&(d=a)});return d}return null}});l.mixin(F,{ALIGN_LEFT:0,ALIGN_RIGHT:1});k("extend-esri")&&l.setObject("dijit.Legend",
F,Z);return F});