// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/arcgis/utils","require dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/Deferred dojo/_base/json dojo/_base/url dojo/on dojo/DeferredList dojo/dom-construct dojo/sniff dojox/gfx/_base ../kernel ../config ../Color ../lang ../request ../SpatialReference ../map ../urlUtils ../geometry/ScreenPoint ../geometry/Extent ../geometry/webMercatorUtils ../symbols/jsonUtils ../renderers/jsonUtils ../dijit/PopupTemplate ../dijit/Popup ../tasks/query ../tasks/GeometryService ../layers/ArcGISTiledMapServiceLayer ../layers/FeatureLayer dojo/i18n!../nls/jsapi".split(" "),
function(J,m,h,v,q,K,ab,U,E,bb,rb,ka,B,L,cb,k,C,D,db,V,la,F,eb,G,I,W,fb,gb,hb,ib,w,X){function H(a){return C({url:r.arcgisUrl+"/"+a.itemId+"/data",content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function Y(a,e){var d={f:"json"};e&&(d.token=e);return C({url:a,content:d,callbackParamName:"callback"},{disableIdentityLookup:!0})}function Z(a){!a.layerDefinition||a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo||(a.showLabels=!1);a.itemProperties.layerDefinition&&
(a.layerDefinition?(a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo=a.itemProperties.layerDefinition.drawingInfo),k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition.definitionExpression=a.itemProperties.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)||(a.layerDefinition.minScale=a.itemProperties.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)||(a.layerDefinition.maxScale=a.itemProperties.layerDefinition.maxScale)):
a.layerDefinition=a.itemProperties.layerDefinition);!a.itemProperties.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=a.itemProperties.popupInfo);k.isDefined(a.itemProperties.showLabels)&&!k.isDefined(a.showLabels)&&(a.showLabels=a.itemProperties.showLabels);k.isDefined(a.itemProperties.showLegend)&&!k.isDefined(a.showLegend)&&(a.showLegend=a.itemProperties.showLegend);k.isDefined(a.itemProperties.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=a.itemProperties.refreshInterval)}
function ma(a){Z(a);a.itemProperties.layerDefinition&&a.layerDefinition&&(!k.isDefined(a.layerDefinition.maximumTrackPoints)&&k.isDefined(a.itemProperties.layerDefinition.maximumTrackPoints)&&(a.layerDefinition.maximumTrackPoints=a.itemProperties.layerDefinition.maximumTrackPoints),!a.layerDefinition.definitionGeometry&&a.itemProperties.layerDefinition.definitionGeometry&&(a.layerDefinition.definitionGeometry=a.itemProperties.layerDefinition.definitionGeometry));a.itemProperties.purgeOptions&&!a.purgeOptions&&
(a.purgeOptions=a.itemProperties.purgeOptions)}function M(a,e){var d=new q;e=a.itemData;var c=[],b=[];h.forEach(e.operationalLayers,function(a){if(a.itemId&&!a.type){var f=a.url.toLowerCase();-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/")?(b.push(a),c.push(H(a))):-1<f.indexOf("/mapserver")&&-1===f.indexOf("/mapserver/")&&(!a.layers||!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale))?(b.push(a),c.push(H(a))):-1<f.indexOf("/imageserver")&&!k.isDefined(a.minScale)&&!k.isDefined(a.maxScale)?
(b.push(a),c.push(H(a))):-1<f.indexOf("/streamserver")&&(b.push(a),c.push(H(a)))}});e.baseMap&&e.baseMap.baseMapLayers&&h.forEach(e.baseMap.baseMapLayers,function(a){a.itemId&&"VectorTileLayer"!==a.layerType&&(b.push(a),c.push(H(a)))});if(0<c.length){var g={};(new E(c)).addCallback(function(c){h.forEach(b,function(a,b){if((b=c[b][1])&&!(b instanceof Error)&&(g[a.itemId]=b,!a.type)){var f=a.url.toLowerCase();(-1<f.indexOf("/featureserver")||-1<f.indexOf("/mapserver/"))&&b.layers?h.forEach(b.layers,
function(b){var c="/featureserver/"+b.id;(c=f.match(c+"$")==c)||(c="/mapserver/"+b.id,c=f.match(c+"$")==c);c&&(a.itemProperties=b,Z(a))}):-1<f.indexOf("/streamserver")?(a.itemProperties=b,ma(a)):-1<f.indexOf("/mapserver")?(b.layers&&!a.layers&&(a.layers=b.layers),k.isDefined(b.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=b.minScale),k.isDefined(b.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),k.isDefined(b.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),
b.visibleLayers&&!a.visibleLayers&&(a.visibleLayers=b.visibleLayers)):-1<f.indexOf("/imageserver")&&(k.isDefined(b.minScale)&&!k.isDefined(a.minScale)&&(a.minScale=b.minScale),k.isDefined(b.maxScale)&&!k.isDefined(a.maxScale)&&(a.maxScale=b.maxScale),k.isDefined(b.refreshInterval)&&!k.isDefined(a.refreshInterval)&&(a.refreshInterval=b.refreshInterval),!b.popupInfo||a.popupInfo||a.disablePopup||(a.popupInfo=b.popupInfo),b.renderingRule&&!a.renderingRule&&(a.renderingRule=b.renderingRule,b.renderingRule.functionName&&
(a.renderingRule.rasterFunction=b.renderingRule.functionName)),b.bandIds&&!a.bandIds&&(a.bandIds=b.bandIds),b.mosaicRule&&!a.mosaicRule&&(a.mosaicRule=b.mosaicRule),b.format&&!a.format&&(a.format=b.format),k.isDefined(b.compressionQuality)&&!k.isDefined(a.compressionQuality)&&(a.compressionQuality=b.compressionQuality),!b.layerDefinition||!b.layerDefinition.definitionExpression||k.isDefined(a.layerDefinition)&&k.isDefined(a.layerDefinition.definitionExpression)||(a.layerDefinition=a.layerDefinition||
{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression))}});a.relatedItemsData=g;d.callback(a)})}else d.callback(a);return d}function jb(a,e){var d=new q,c=a.itemData,b=c.baseMap.baseMapLayers[0];if("BingMapsAerial"===b.type||"BingMapsRoad"===b.type||"BingMapsHybrid"===b.type)if(b.portalUrl&&B.id)delete e.bingMapsKey,B.id.checkSignInStatus(V.urlToObject(r.arcgisUrl).path).then(m.hitch(null,function(a,c,d,e,g){Y(b.portalUrl,g.token).then(m.hitch(null,aa,a,c,d,e),m.hitch(null,
N,a,c,d,e))},a,e,c,d),m.hitch(null,function(a,c,d,e,g){Y(b.portalUrl).then(m.hitch(null,aa,a,c,d,e),m.hitch(null,N,a,c,d,e))},a,e,c,d));else if(e.bingMapsKey){var g=new y({bingMapsKey:e.bingMapsKey,mapStyle:y.MAP_STYLE_AERIAL});v.connect(g,"onLoad",m.hitch(this,function(){d.callback([a,e])}));v.connect(g,"onError",function(f){delete e.bingMapsKey;a.itemData=O(c);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});
d.callback([a,e])})}else a.itemData=O(c),b=a.itemData.baseMap.baseMapLayers[0],b.errors=[],b.errors.push({message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."}),d.callback([a,e]);else d.callback([a,e]);return d}function kb(a){var e=new q,d,c;a=a.itemData;var b=a.baseMap&&a.baseMap.baseMapLayers;if(P&&!P.supported())for(a=0;a<b.length;a++){var g=b[a];if(!g.isReference){"VectorTileLayer"===g.layerType&&(d=g.itemId,c=a);break}}d?ba(d,
!1).addBoth(function(a){var f=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;a&&a.item&&f.test(a.item.url)&&(b[c]={id:"FB_"+g.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in g?g.opacity:1,visibility:"visibility"in g?g.visibility:!0,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"});e.resolve()}):e.resolve();return e}function aa(a,e,d,c,b){b.bingKey?(e.bingMapsKey=b.bingKey,b=new y({bingMapsKey:e.bingMapsKey,
mapStyle:y.MAP_STYLE_AERIAL}),v.connect(b,"onLoad",m.hitch(this,function(){c.callback([a,e])})),v.connect(b,"onError",function(b){delete e.bingMapsKey;a.itemData=O(d);b=a.itemData.baseMap.baseMapLayers[0];b.errors=[];b.errors.push({message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."});c.callback([a,e])})):N(a,e,d,c)}function N(a,e,d,c){delete e.bingMapsKey;a.itemData=O(d);d=a.itemData.baseMap.baseMapLayers[0];d.errors=[];d.errors.push({message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."});
c.callback([a,e])}function O(a){a.baseMap="BingMapsAerial"===a.baseMap.baseMapLayers[0].type?{title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===a.baseMap.baseMapLayers[0].type?{title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:{title:"Imagery with Labels",
baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]};return a}function ca(a,e,d,c){var b=a.dynamicLayerInfos||a.layerInfos,g=e.layers;if(g&&b)if(c.usePopupManager){var f;h.forEach(b,function(a){var b=a.id;if(!a.subLayerIds)for(a=
0;a<g.length;a++){var c=g[a];if(c.id===b&&c.popupInfo){f||(f={});f[b]={infoTemplate:new d(c.popupInfo),layerUrl:c.layerUrl};break}}});f&&a.setInfoTemplates(f)}else{var l=[],n=[],x=[],p=[],u=[],t=[];h.forEach(b,function(b){var c=b.id;if(!b.subLayerIds&&-1!==h.indexOf(a.visibleLayers,c))for(b=0;b<g.length;b++){var f=g[b];if(f.id===c){n.push(c);l.push(f.popupInfo);x.push(f.layerUrl||"");f.layerDefinition&&f.layerDefinition.definitionExpression?p.push(f.layerDefinition.definitionExpression):p.push("");
u.push(k.isDefined(f.minScale)?f.minScale:null);t.push(k.isDefined(f.maxScale)?f.maxScale:null);break}}});l.length&&(a.__popups=l,a.__popupIds=n,a.__popupUrls=x,a.__popupWhereClauses=p,a.__popupMinScales=u,a.__popupMaxScales=t,a.__resourceInfo=e.resourceInfo)}}function oa(a){if(!a)return!1;var e=(new ab(r.arcgisUrl)).authority;return-1!==a.indexOf(".arcgis.com/")||-1!==a.indexOf(e)}function pa(a){return a?-1!==a.indexOf("/services.arcgisonline.com/")||-1!==a.indexOf("/server.arcgisonline.com/"):!1}
function A(a){"https:"===location.protocol&&(oa(a)||pa(a))&&(a=a.replace("http:","https:"));return a}function da(a,e,d){var c=[],b;a.displayLevels||(c=h.map(a.resourceInfo.tileInfo.lods,function(a){return a.level}));a.exclusionAreas&&(b=m.clone(a.exclusionAreas),b=h.map(b,function(a){a.geometry=new F(a.geometry);return a}));c=new ib(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,displayLevels:a.displayLevels||c,id:a.id,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval,
exclusionAreas:b});d.ignorePopups||ca(c,a,e,d);return c}function ea(a,e){if(!a||!e||0===e.length)return[];e=","+e+",";var d=[],c,b=",";for(c=0;c<a.length;c++)if(null!==a[c].subLayerIds){if(-1===e.indexOf(","+a[c].id+",")||-1<b.indexOf(","+a[c].id+","))b+=a[c].subLayerIds.toString()+","}else-1<e.indexOf(","+a[c].id+",")&&-1===b.indexOf(","+a[c].id+",")&&d.push(a[c].id);return d}function qa(a,e,d){var c=new ra;c.format="png24";a.resourceInfo&&a.resourceInfo.supportedImageFormatTypes&&-1<a.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")&&
(c.format="png32");var c=new sa(A(a.url),{resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval}),b=a.visibleLayers;if(!a.visibleLayers){var g="";h.forEach(c.layerInfos,function(a){a.defaultVisibility&&(g+=(0<g.length?",":"")+a.id)});b=g}if(a.layers&&0<a.layers.length){var f=[],l=[],n,x=[],p,k;h.forEach(a.layers,function(b){var c=b.layerDefinition;c&&c.definitionExpression&&(f[b.id]=c.definitionExpression);
if(c&&c.source){n=null;k=c.source;if("mapLayer"===k.type){var d=h.filter(a.resourceInfo.layers,function(a){return a.id===k.mapLayerId});d.length&&(n=m.mixin(d[0],b))}else n=m.mixin({},b);n&&(n.source=k,delete n.popupInfo,n=new ta(n),a.visibleLayers&&(d="string"==typeof a.visibleLayers?a.visibleLayers.split(","):a.visibleLayers,-1<h.indexOf(d,b.id)?n.defaultVisibility=!0:n.defaultVisibility=!1),l.push(n))}c&&null!=c.transparency&&(d=c.drawingInfo||{},null==d.transparency&&(d.transparency=c.transparency,
c.drawingInfo=d));c&&c.source&&c.drawingInfo&&(p=new ua(c.drawingInfo),x[b.id]=p)},this);0<f.length&&c.setLayerDefinitions(f);0<l.length?(c.setDynamicLayerInfos(l,!0),0<x.length&&c.setLayerDrawingOptions(x,!0)):(b=ea(c.layerInfos,b),c.setVisibleLayers(b))}else b=ea(c.layerInfos,b),c.setVisibleLayers(b);d.ignorePopups||ca(c,a,e,d);return c}function lb(a,e,d){var c=new va;c.bandIds=a.bandIds;null!=a.format&&(c.format=a.format,null!=a.compressionQuality&&(c.compressionQuality=a.compressionQuality));
if(a.renderingRule&&a.renderingRule.rasterFunction){var b=new wa(a.renderingRule);c.renderingRule=b}a.mosaicRule&&(b=new xa(a.mosaicRule),c.mosaicRule=b);k.isDefined(a.noData)&&(c.noData=a.noData);k.isDefined(a.noDataInterpretation)&&(c.noDataInterpretation=a.noDataInterpretation);k.isDefined(a.interpolation)&&(c.interpolation=a.interpolation);b=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1;k.isDefined(a.layerType)||(b=a.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===
a.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.resourceInfo.serviceDataType));c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,id:a.id,imageServiceParameters:c,minScale:a.minScale,maxScale:a.maxScale,refreshInterval:a.refreshInterval};c=b?new ya(A(a.url),c):new za(A(a.url),c);a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(b=I.fromJson(a.layerDefinition.drawingInfo.renderer),c.setRenderer(b)),a.layerDefinition.definitionExpression&&
c.setDefinitionExpression(a.layerDefinition.definitionExpression,!0));!d.ignorePopups&&a.popupInfo&&c.setInfoTemplate(new e(a.popupInfo));return c}function fa(a,e,d){var c=[102113,102100,3857],b=d||new D(e[0].layerObject.fullExtent.spatialReference),g=new D(a.resourceInfo.fullExtent.spatialReference);return b.wkt==g.wkt&&(b.wkid==g.wkid||k.isDefined(b.latestWkid)&&b.latestWkid==g.wkid||k.isDefined(g.latestWkid)&&b.wkid==g.latestWkid||k.isDefined(b.latestWkid)&&b.latestWkid==g.latestWkid)||b.wkid&&
g.wkid&&h.some(c,function(a){return a===g.wkid})&&h.some(c,function(a){return a===b.wkid})?!0:!1}function ga(a,e,d){if(!e[0].layerObject.tileInfo)return!1;a=a.resourceInfo.tileInfo;e=e[0].layerObject.tileInfo;d=d.width>d.height?d.width:d.height;for(var c=!1,b=!1,g=0;g<a.lods.length;g++){for(var f=a.lods[g].scale/a.dpi,l=0;l<e.lods.length;l++){var n=e.lods[l].scale/e.dpi;if(Math.abs(n-f)/n<1/d)if(c){b=!0;break}else c=!0}if(b)break}return b||c&&(1===a.lods.length||1===e.lods.length)?!0:!1}function Aa(a,
e,d,c,b,g){var f,l,n=d._clazz;if("OpenStreetMap"===a.type)f=new Ba({id:a.id,opacity:a.opacity,visible:null!==a.visibility&&void 0!==a.visibility?a.visibility:!0});else if("WFS"===a.type)c={customParameters:a.wfsInfo.customParameters,geometryType:a.layerDefinition.geometryType,id:a.id,labelingInfo:a.layerDefinition.drawingInfo.labelingInfo,maxFeatures:a.wfsInfo.maxFeatures,mode:a.mode,name:a.wfsInfo.name,showLabels:!0,swapXY:a.wfsInfo.swapXY,title:a.title,url:a.url,version:a.wfsInfo.version,visible:a.visibility,
wkid:a.layerDefinition.spatialReference.wkid},f=new Ca,f.fromJson(c,function(){k.isDefined(a.opacity)&&f.setOpacity(a.opacity);k.isDefined(a.visibility)&&f.setVisibility(a.visibility);(a.minScale||a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);f.renderer=I.fromJson(a.layerDefinition.drawingInfo.renderer);!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new n(a.popupInfo));f.emit("fromJsonComplete")});else if("WMS"===a.type){var x=[],p=[];h.forEach(a.layers,function(a){p.push(new Da({name:a.name,
title:a.title,legendURL:a.legendURL,queryable:a.queryable,showPopup:a.showPopup}));x.push(a.name)},this);a.visibleLayers&&(x=a.visibleLayers);c=new F(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new D({wkid:4326}));c={customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,extent:c,layerInfos:p,version:a.version,maxWidth:a.maxWidth,maxHeight:a.maxHeight,featureInfoFormat:a.featureInfoFormat,getFeatureInfoURL:a.featureInfoUrl,getMapURL:a.mapUrl,spatialReferences:a.spatialReferences,
title:a.title,copyright:a.copyright,minScale:a.minScale||0,maxScale:a.maxScale||0,format:a.format};f=new Ea(a.url,{id:a.id,visibleLayers:x,format:"png",transparent:a.firstLayer?!1:!0,opacity:a.opacity,visible:null!==a.visibility?a.visibility:!0,resourceInfo:c,refreshInterval:a.refreshInterval});f.spatialReference.wkid=c.spatialReferences[0]}else if("KML"===a.type){l=a.url;if(B.id){var u=B.id.findCredential(V.urlToObject(r.arcgisUrl).path);u&&(e=r.arcgisUrl.substring(r.arcgisUrl.indexOf("//")+2,r.arcgisUrl.indexOf("/",
r.arcgisUrl.indexOf("//")+3)),b=e.split("."),b=b[b.length-2]+"."+b[b.length-1],g=l.indexOf(b),-1<g&&(l="https://"+e+l.substring(g+b.length),l+="?token\x3d"+u.token))}f=new Fa(l,{id:a.id,visible:null!==a.visibility?a.visibility:!0,outSR:c,refreshInterval:a.refreshInterval});v.connect(f,"onLoad",function(){(a.opacity||0===a.opacity)&&f.setOpacity(a.opacity);k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);a.visibleFolders&&h.forEach(f.folders,function(c){-1<h.indexOf(a.visibleFolders,
c.id)?f.setFolderVisibility(c,!0):f.setFolderVisibility(c,!1)},this)})}else if("WebTiledLayer"===a.type){if(f=new Ga(a.templateUrl,{id:a.id,visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,copyright:a.copyright,fullExtent:a.fullExtent&&new F(a.fullExtent),initialExtent:a.fullExtent&&new F(a.fullExtent),subDomains:a.subDomains,tileInfo:a.tileInfo?new Ha(a.tileInfo):null,refreshInterval:a.refreshInterval,wmtsInfo:a.wmtsInfo}),k.isDefined(a.minScale)||k.isDefined(a.maxScale))f.loaded?f.setScaleRange(a.minScale,
a.maxScale):v.connect(f,"onLoad",function(){f.setScaleRange(a.minScale,a.maxScale)})}else if("GeoRSS"===a.type)f=new Ia(a.url,{id:a.id,opacity:a.opacity,outSpatialReference:c,refreshInterval:a.refreshInterval}),v.connect(f,"onLoad",function(){!1===a.visibility&&f.hide();k.isDefined(a.minScale)&&k.isDefined(a.maxScale)&&f.setScaleRange(a.minScale,a.maxScale);var c=f.getFeatureLayers();h.forEach(c,function(b){a.pointSymbol&&"esriGeometryPoint"===b.geometryType?(b.renderer.symbol=G.fromJson(a.pointSymbol),
1===c.length&&(f.pointSymbol=G.fromJson(a.pointSymbol))):a.lineSymbol&&"esriGeometryPolyline"===b.geometryType?(b.renderer.symbol=G.fromJson(a.lineSymbol),1===c.length&&(f.polylineSymbol=G.fromJson(a.lineSymbol))):a.polygonSymbol&&"esriGeometryPolygon"===b.geometryType&&(b.renderer.symbol=G.fromJson(a.polygonSymbol),1===c.length&&(f.polygonSymbol=G.fromJson(a.polygonSymbol)))})});else if("CSV"==a.type&&a.url)c={layerDefinition:a.layerDefinition,columnDelimiter:a.columnDelimiter,id:a.id?a.id:null,
visible:null!==a.visibility?a.visibility:!0,opacity:a.opacity,refreshInterval:a.refreshInterval},a.locationInfo&&(c.latitudeFieldName=a.locationInfo.latitudeFieldName,c.longitudeFieldName=a.locationInfo.longitudeFieldName),d.ignorePopups||(c.infoTemplate=new W(a.popupInfo?a.popupInfo:Ja.generateDefaultPopupInfo(a))),f=new Ka(a.url,c);else if("VectorTileLayer"===a.layerType&&a.styleUrl)f=new P(a.styleUrl,{id:a.id,minScale:a.minScale,maxScale:a.maxScale,opacity:a.opacity,visible:a.visibility});else if(a.layerDefinition&&
!a.url)c=K.fromJson(K.toJson(a)),delete c.id,delete c.opacity,delete c.visibility,f=new w(c,{id:a.id,opacity:a.opacity,visible:a.visibility,outFields:["*"],autoGeneralize:!0}),!d.ignorePopups&&c.popupInfo&&f.setInfoTemplate(new n(c.popupInfo)),La(f);else if("BingMapsAerial"===a.type||"BingMapsRoad"===a.type||"BingMapsHybrid"===a.type)d.bingMapsKey?(c=y.MAP_STYLE_AERIAL_WITH_LABELS,"BingMapsAerial"===a.type?c=y.MAP_STYLE_AERIAL:"BingMapsRoad"===a.type&&(c=y.MAP_STYLE_ROAD),f=new y({bingMapsKey:d.bingMapsKey,
mapStyle:c,opacity:a.opacity,id:a.id}),v.connect(f,"onError",m.hitch(this,function(a){a.errors=a.errors||[];a.errors.push({message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"})},a))):(a.errors=a.errors||[],a.errors.push({message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+a.type+"]"}));else if(a.resourceInfo&&a.resourceInfo.mapName)f=!0===a.resourceInfo.singleFusedMapCache&&
(a.baseMapLayer||fa(a,e,c)&&ga(a,b,g))?da(a,n,d):qa(a,n,d);else if(a.resourceInfo&&a.resourceInfo.pixelSizeX)f=!0===a.resourceInfo.singleFusedMapCache&&(a.baseMapLayer||fa(a,e,c)&&ga(a,b,g))?da(a,n,d):lb(a,n,d);else if(a.resourceInfo&&"Feature Layer"===a.resourceInfo.type){a.capabilities&&(a.resourceInfo.capabilities=a.capabilities);var t;!1===d.editable?t=!1:d.privileges&&-1===h.indexOf(d.privileges,"features:user:edit")&&B.id&&B.id.findCredential(a.url)&&(t=!1);f=new w(A(a.url),{resourceInfo:a.resourceInfo,
opacity:a.opacity,visible:a.visibility,id:a.id,mode:a.mode===w.MODE_SELECTION?w.MODE_SELECTION:w.MODE_AUTO,editable:t,outFields:["*"],autoGeneralize:!0,refreshInterval:a.refreshInterval});!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new n(a.popupInfo));a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer&&(c=I.fromJson(a.layerDefinition.drawingInfo.renderer),c.isMaxInclusive=!0,f.setRenderer(c)),a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.labelingInfo&&
(c=h.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new Ma(a)}),f.setLabelingInfo(c)),a.layerDefinition.definitionExpression&&f.setDefinitionExpression(a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale));La(f)}else a.resourceInfo&&a.resourceInfo.streamUrls&&(c={resourceInfo:a.resourceInfo,opacity:a.opacity,visible:a.visibility,
id:a.id},a.layerDefinition&&(u=a.layerDefinition.drawingInfo,a.layerDefinition.definitionGeometry&&(l=l||{},l.geometry=a.layerDefinition.definitionGeometry),k.isDefined(a.layerDefinition.definitionExpression)&&(l=l||{},l.where=a.layerDefinition.definitionExpression),k.isDefined(a.layerDefinition.maximumTrackPoints)&&(c.maximumTrackPoints=a.layerDefinition.maximumTrackPoints)),l&&(c.filter=l),a.purgeOptions&&(c.purgeOptions=a.purgeOptions),f=new Na(A(a.url),c),u&&u.renderer&&(c=u.renderer,f.setRenderer(I.fromJson(c))),
!d.ignorePopups&&a.popupInfo&&f.setInfoTemplate(new n(a.popupInfo)),a.layerDefinition&&(k.isDefined(a.layerDefinition.minScale)&&f.setMinScale(a.layerDefinition.minScale),k.isDefined(a.layerDefinition.maxScale)&&f.setMaxScale(a.layerDefinition.maxScale)),U.once(f,"error",function(c){a.errors.push({message:"Error loading stream layer. Check websocket url"})}));f&&(f.arcgisProps={title:a.title},a.baseMapLayer&&(a.isReference?(f.attr("data-reference",!0),f._basemapGalleryLayerType="reference"):f._basemapGalleryLayerType=
"basemap"),f instanceof w&&a.layerDefinition&&a.layerDefinition.featureReduction&&"cluster"===a.layerDefinition.featureReduction.type&&(c=a.layerDefinition.featureReduction,c.clusterSize&&(c.clusterSize=ka.pt2px(c.clusterSize)),c.clusterRadius&&(c.clusterRadius=ka.pt2px(c.clusterRadius)),c.popupInfo&&(c.infoTemplate=new W(c.popupInfo),delete c.popupInfo),f.setFeatureReduction(c)));return f}function ha(a,e,d,c,b){h.forEach(a,function(f){f.layerObject=Aa(f,a,e,d,c,b)});var g=h.filter(a,function(a){return!a.isReference}),
f=h.filter(a,function(a){return!!a.isReference});return a=g.concat(f)}function ia(a){var e=null;a=a[0];a.url&&!a.type?a.resourceInfo.spatialReference&&(e=new D,a.resourceInfo.spatialReference.wkid&&(e.wkid=a.resourceInfo.spatialReference.wkid),a.resourceInfo.spatialReference.wkt&&(e.wkt=a.resourceInfo.spatialReference.wkt)):a.type&&(-1<a.type.indexOf("BingMaps")||"OpenStreetMap"==a.type?e=new D({wkid:102100}):"WMS"==a.type&&(e=new D({wkid:a.spatialReferences[0]})));return e}function Oa(a,e,d,c,b,
g,f,l){h.forEach(e,function(c){c.url&&!c.type&&(c.resourceInfo=a[c.deferredsPos][1],delete c.deferredsPos)});g=g||ia(e);e=ha(e,d,g,f,l);b.callback(e);return b}function La(a){!window.CanvasRenderingContext2D&&a.renderer&&"esri.renderer.HeatmapRenderer"===a.renderer.declaredClass&&a.setRenderer(I.fromJson({type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}}))}
function Pa(a,e){var d=A(a);return C({url:d,content:{f:"json"},callbackParamName:"callback",error:function(a,b){a.message=a.message?a.message+(" [url:"+d+"]"):"[url:"+d+"]";e.push(a);L.defaults.io.errorHandler(a,b)}})}function Qa(a){var e=r.arcgisUrl+"/"+a.itemId+"/data";return C({url:e,content:{f:"json"},callbackParamName:"callback",error:function(d,c){d.message=d.message?d.message+(" [url:"+e+"]"):"[url:"+e+"]";a.errors=a.errors||[];a.errors.push(d);L.defaults.io.errorHandler(d,c)}})}function Ra(a,
e,d){var c=new q;if(!(d.featureCollection&&d.featureCollection.layers||d.layers))return console.log("Invalid Feature Collection item data [item id: "+a.itemId+"]: ",d),a.errors=a.errors||[],a.errors.push({message:"Invalid Feature Collection item data. [item id: "+a.itemId+"]"}),c.errback(),c;d.layers&&(d.featureCollection={layers:d.layers},delete d.layers,k.isDefined(d.showLegend)&&(d.featureCollection.showLegend=d.showLegend,delete d.showLegend));Sa(a,d.featureCollection,e).then(function(b){d.featureCollection=
b;a.featureCollection&&a.featureCollection.layers?h.forEach(d.featureCollection.layers,function(c,b){b=a.featureCollection.layers[b];b.popupInfo||b.layerDefinition?b.layerDefinition?(k.isDefined(b.layerDefinition.minScale)&&k.isDefined(b.layerDefinition.maxScale)&&(b.layerDefinition.minScale!==c.layerDefinition.minScale||b.layerDefinition.maxScale!==c.layerDefinition.maxScale)&&(delete c.layerDefinition.minScale,delete c.layerDefinition.maxScale),b.layerDefinition.drawingInfo&&K.toJson(b.layerDefinition.drawingInfo)!==
K.toJson(c.layerDefinition.drawingInfo)&&delete c.layerDefinition.drawingInfo,b.layerDefinition.showLegend!==c.layerDefinition.showLegend&&delete c.layerDefinition.showLegend,b.layerDefinition=m.mixin(b.layerDefinition,c.layerDefinition)):b.layerDefinition=c.layerDefinition:(b.popupInfo=c.popupInfo,b.layerDefinition=c.layerDefinition);b.featureSet=c.featureSet;b.nextObjectId=c.nextObjectId}):(a.featureCollection=a.featureCollection||{},a.featureCollection=m.mixin(a.featureCollection,d.featureCollection));
c.callback(a)});return c}function Sa(a,e,d){var c=new q;J(["./csv"],function(b){var g=[];h.forEach(e.layers,function(a){a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference&&(a.deferredsPos=g.length,g.push(b.projectFeatureCollection(a,d,a.featureSet.features[0].geometry.spatialReference)))});(new E(g)).addCallback(function(){h.forEach(e.layers,function(b){k.isDefined(b.deferredsPos)&&(g[b.deferredsPos].results&&
g[b.deferredsPos].results.length?b=g[b.deferredsPos].results[0]:(console.log("Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"),b.errors=b.errors||[],b.errors.push({message:"Errors projecting feature collection. ["+a.title+" - "+b.layerDefinition.name+"]"})),delete b.deferredsPos)});c.callback(e)})});return c}function Q(a,e,d,c,b){var g=new q,f=new q,l=[],n;h.forEach(a.operationalLayers,function(a){a.itemId&&"Feature Collection"==a.type&&l.push(Qa(a).then(m.hitch(null,
Ra,a,d)))});0===l.length?Ta(a,e,d,c,f,b):(n=new E(l),n.addCallback(function(g){Ta(a,e,d,c,f,b)}));f.then(function(a){l=[];h.forEach(a,function(a){var b;a=a.layerObject;a instanceof w&&!a.loaded&&!a.loadError?(b=new q,U.once(a,"load, error",function(){b.callback(a)}),l.push(b)):a&&"esri.layers.WFSLayer"===a.declaredClass&&!a.loadError&&(b=new q,U.once(a,"fromJsonComplete, error",function(c){b.callback(a)}),l.push(b))});if(l.length){var b=new q;n=new E(l);n.addCallback(function(){b.callback(a)});return b.promise}return a}).then(function(a){var b=
[];h.forEach(a,function(a){var c=a.layerObject;c instanceof w?c.loaded&&c.labelingInfo&&(a.showLabels||c._collection)&&b.push(c):c&&"esri.layers.WFSLayer"===c.declaredClass&&c.loaded&&c.labelingInfo&&b.push(c)});b.length?J(["../layers/LabelLayer"],function(c){var d=new c;h.forEach(b,function(a){d.addFeatureLayer(a)});a.push({layerObject:d});g.callback(a)}):g.callback(a)});return g}function Ta(a,e,d,c,b,g){var f=[],l=[],n=[];h.forEach(a.operationalLayers,function(a,b){if(a.featureCollection&&a.featureCollection.layers){var c=
a.featureCollection.layers.length;h.forEach(a.featureCollection.layers,function(d,e){var f=!0;a.visibleLayers&&-1==h.indexOf(a.visibleLayers,e)&&(f=!1);d.visibility=a.visibility&&f;d.opacity=a.opacity;d.id=(a.id||"operational"+b)+"_"+e;a.title&&(d.title=1!==c&&d.layerDefinition.name&&a.title!==d.layerDefinition.name?a.title+" - "+d.layerDefinition.name:a.title);n.push(d)},this)}else n.push(a)});h.forEach(a.baseMap.baseMapLayers,function(a,b){a.baseMapLayer=!0;a.id=a.id||"base"+b;f.push(a)});h.forEach(n,
function(a,b){a.id=a.id||"operational"+b;f.push(a)});h.forEach(f,function(a){a.url&&!a.type&&(a.deferredsPos=l.length,a.errors=a.errors||[],l.push(Pa(a.url,a.errors)))});0===l.length?(d=d||ia(f),f=ha(f,e,d,c,g),b.callback(f)):(new E(l)).addCallback(function(a){Oa(a,f,e,l,b,d,c,g)});return b}function R(a,e,d,c){var b=a.minScale,g=a.maxScale;if(10.1>=d.version&&e)for(a=e.length-1;0<=a;a--){if(e[a].id==c)if(0==b&&0<e[a].minScale?b=e[a].minScale:0<b&&0==e[a].minScale?b=d.minScale:0<b&&0<e[a].minScale&&
(b=Math.min(b,e[a].minScale)),g=Math.max(d.maxScale||0,e[a].maxScale||0),d.setScaleRange(b,g),-1<e[a].parentLayerId)c=e[a].parentLayerId;else break}else 10.1<d.version&&(h.forEach(a.layerInfos,function(a){a.id==c&&(0==b&&0<a.minScale?b=a.minScale:0<b&&0==a.minScale||0<b&&0<a.minScale&&(b=Math.min(b,a.minScale)),g=Math.max(g||0,a.maxScale||0))}),d.setScaleRange(b,g))}function S(a,e,d,c){var b=a.url,g=a.__popupIds,f=a.__popupUrls,l=a.__popupWhereClauses,n=a.__popupMinScales,x=a.__popupMaxScales,p=a.__resourceInfo,
u=[];h.forEach(a.__popups,function(c,m){if(c){var t,r=[];h.forEach(c.fieldInfos,function(a){"shape"!==a.fieldName.toLowerCase()&&r.push(a.fieldName)});if(a.dynamicLayerInfos&&0<a.dynamicLayerInfos.length){var q=h.filter(a.dynamicLayerInfos,function(a){return g[m]==a.id})[0].source;t=new w(b+"/dynamicLayer",{parentLayer:a,id:a.id+"_"+g[m],source:q,outFields:r,mode:w.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,autoGeneralize:!0});var na=function(b,c){0<l[b].length&&c.setDefinitionExpression(l[b]);
if(k.isDefined(n[b])||k.isDefined(x[b]))if(k.isDefined(a.minScale)||k.isDefined(a.maxScale)){var d=a.minScale,f=a.maxScale;0==d&&0<n[b]?d=n[b]:0<d&&0==n[b]||0<d&&0<n[b]&&(d=Math.min(d,n[b]));f=Math.max(f||0,x[b]||0);c.setScaleRange(d,f)}else c.setScaleRange(n[b],x[b]);else R(a,e||p.layers,c,g[b])};t.loaded?na(m,t):v.connect(t,"onLoad",function(a){na(m,t)})}else{var y=null,z=b+"/"+g[m];if(f[m].length)z=f[m];else if(e)for(q=0;q<e.length;q++)if(e[q].id===g[m]){y=e[q];break}t=new w(A(z),{parentLayer:a,
id:a.id+"_"+g[m],outFields:r,mode:w.MODE_SELECTION,infoTemplate:c&&new d(c),drawMode:!1,visible:a.visible,resourceInfo:y,autoGeneralize:!0});t.loaded?(0<l[m].length&&t.setDefinitionExpression(l[m]),R(a,e||p.layers,t,g[m])):v.connect(t,"onLoad",function(b){0<l[m].length&&t.setDefinitionExpression(l[m]);R(a,e||p.layers,b,g[m])})}u.push(t)}});0<u.length&&(v.connect(a,"onVisibilityChange",m.hitch(this,function(a,b){h.forEach(a,function(a){b?a.show():a.hide()})},u)),v.connect(c,"onLayerRemove",m.hitch(this,
function(a,b,d){a.id===d.id&&h.forEach(b,function(a){c.removeLayer(a)})},a,u)));delete a.__popups;delete a.__popupIds;delete a.__popupUrls;delete a.__popupWhereClauses;delete a.__popupMinScales;delete a.__popupMaxScales;delete a.__resourceInfo;return u}function Ua(a){return C({url:A(a.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function Va(a,e,d){var c=[];h.forEach(a,function(a){var b=a.__popups;b&&1<b.length&&10<=a.version&&(a.__deferredsPos=c.length,c.push(Ua(a)))});
var b=[];0<c.length?(new E(c)).addCallback(function(c){h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(a.__deferredsPos||0===a.__deferredsPos?(b=b.concat(S(a,c[a.__deferredsPos][1].layers,d,e)),delete a.__deferredsPos):b=b.concat(S(a,null,d,e)))});e.addLayers(b)}):(h.forEach(a,function(a){a.__popups&&0<a.__popups.length&&(b=b.concat(S(a,null,d,e)))}),e.addLayers(b))}function Wa(a){h.forEach(a,function(a){var d=a.layer;d.toJson&&(a=d.toJson(),a.featureSet&&d.name&&-1<d.name.indexOf("Text")&&
h.forEach(a.featureSet.features,function(a,b){a.attributes.TEXT&&(b=d.graphics[b],b.symbol.setText(a.attributes.TEXT),a.symbol.horizontalAlignment&&(b.symbol.align=a.symbol.horizontalAlignment),b.setSymbol(b.symbol),b.setAttributes(a.attributes))},this))})}function Xa(a){var e=6;h.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset))),a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))):"esri.renderer.UniqueValueRenderer"!==
a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||h.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(e=Math.max(e,Math.abs(a.xoffset)));a&&a.yoffset&&(e=Math.max(e,Math.abs(a.yoffset)))})});return e}function ja(a){var e=this,d=e.infoWindow,c=a.graphic;if(e.loaded){d.hide();d.clearFeatures();var b=[];h.forEach(e.graphicsLayerIds,function(a){(a=e.getLayer(a))&&a instanceof w&&a.loaded&&a.visible&&(a.clearSelection(),a.infoTemplate&&!a.suspended&&b.push(a))});h.forEach(e.layerIds,
function(a){(a=e.getLayer(a))&&-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")&&a.loaded&&a.visible&&a.infoTemplate&&b.push(a)});c=c&&c.getInfoTemplate()?c:null;if(b.length||c){var g=Xa(b),f=a.screenPoint,l=e.toMap(new la(f.x-g,f.y+g)),g=e.toMap(new la(f.x+g,f.y-g)),n=new F(l.x,l.y,g.x,g.y,e.spatialReference),k=new gb;k.geometry=n;k.timeExtent=e.timeExtent;var p=!0,l=h.map(b,function(b){b=b&&b.isFeatureReductionActive&&b.isFeatureReductionActive()?b.getFeatureReductionLayer():b;var c;if(-1!==
b.declaredClass.indexOf("ArcGISImageServiceLayer"))k.geometry=a.mapPoint,p=!1,c=b.queryVisibleRasters(k,{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.addCallback(function(){return b.getVisibleRasters()});else if("function"===typeof b.selectFeatures)c=b.selectFeatures(k),c.addCallback(function(){return b.getSelectedFeatures()});else{c=new q;var d=h.filter(b.graphics,function(a){return a&&a.visible&&n.intersects(a.geometry)});c.resolve(d)}return c});c&&(g=new q,g.callback([c]),
l.splice(0,0,g));if(!h.some(l,function(a){return-1===a.fired})){var m=c?1:0;h.forEach(b,function(a){m=-1!==a.declaredClass.indexOf("ArcGISImageServiceLayer")?m+a.getVisibleRasters().length:m+a.getSelectedFeatures().length});if(!m)return}d.setFeatures(l);d.show(a.mapPoint,{closestFirst:p})}}}function mb(a,e){var d=e.mapOptions||{},c;d.infoWindow||(c=new fb({visibleWhenEmpty:!1},bb.create("div")),d.infoWindow=c);k.isDefined(d.showInfoWindowOnClick)||e.usePopupManager||(d.showInfoWindowOnClick=!1);a=
new db(a,d);v.connect(a,"onLayersAddResult",Wa);return a}function z(a,e,d,c,b,g){var f,l,n,k;c.map?(f=c.map,l=c.clickEventHandle,n=c.clickEventListener,k=c.errors):(f=mb(c,b),b.ignorePopups||b.disableClickBehavior||b.usePopupManager||(l=v.connect(f,"onClick",ja),n=ja));f.addLayers(a);b.ignorePopups||b.usePopupManager||Va(a,f,b._clazz);var p=k||[];h.forEach(e,function(a){a.errors&&(p=p.concat(a.errors))},this);f.loaded?g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:l,clickEventListener:n}):
v.connect(f,"onLoad",function(){g.callback({map:f,itemInfo:d,errors:p,clickEventHandle:l,clickEventListener:n})})}function T(a,e,d,c,b){var g=[];h.forEach(b,function(a){m.isArray(a.layerObject)?h.forEach(a.layerObject,function(a){g.push(a)}):g.push(a.layerObject)});if("BingMapsAerial"===b[0].type||"BingMapsRoad"===b[0].type||"BingMapsHybrid"===b[0].type)var f=setInterval(function(){if(b[0].layerObject&&b[0].layerObject.loaded)clearInterval(f),Ya(a,e,d,c,b,g);else if(b[0].errors){clearInterval(f);
var n="";b[0].errors&&b[0].errors.length&&(n=" ("+b[0].errors[0].message+")");c.errback(Error(X.arcgis.utils.baseLayerError+n))}},10);else if(!g[0]&&b[0].baseMapLayer){var l="";b[0].errors&&b[0].errors.length&&(l=" ("+b[0].errors[0].message+")");c.errback(Error(X.arcgis.utils.baseLayerError+l))}else Ya(a,e,d,c,b,g)}function Ya(a,e,d,c,b,g){try{var f=d.mapOptions||{};d.mapOptions=f;var l=a.item,n=a.itemData;!f.backgroundColor&&n.background&&n.background.color&&null!=n.background.color[0]&&(f.backgroundColor=
cb.toDojoColor(n.background.color));g=h.filter(g,k.isDefined);if(l)if(l.extent&&l.extent.length)if(f.extent)z(g,b,a,e,d,c);else{var m=new F(l.extent[0][0],l.extent[0][1],l.extent[1][0],l.extent[1][1],new D({wkid:4326})),p=g[0].spatialReference;4326===p.wkid?(f.extent=m,z(g,b,a,e,d,c)):102100===p.wkid||102113===p.wkid||3857===p.wkid?(m.xmin=Math.max(m.xmin,-180),m.xmax=Math.min(m.xmax,180),m.ymin=Math.max(m.ymin,-89.99),m.ymax=Math.min(m.ymax,89.99),f.extent=eb.geographicToWebMercator(m),z(g,b,a,e,
d,c)):d.geometryServiceURL||L.defaults.geometryService?(d.geometryServiceURL?new hb(d.geometryServiceURL):L.defaults.geometryService).project([m],p,function(n){n=n[0];f.extent=f.extent||n;z(g,b,a,e,d,c)},function(){z(g,b,a,e,d,c)}):c.errback(Error(X.arcgis.utils.geometryServiceError))}else z(g,b,a,e,d,c);else z(g,b,a,e,d,c)}catch(u){c.errback(u)}}function nb(a){var e=[];h.forEach(a.operationalLayers,function(a){a.featureCollection?e.push({featureCollection:a.featureCollection,visibility:a.visibility,
title:a.title}):a.layerObject&&e.push({layer:a.layerObject,visibility:a.visibility,title:a.title})});return e}function Za(a){var e=[],d=a.baseMap.baseMapLayers;a.operationalLayers&&(d=d.concat(a.operationalLayers));h.forEach(d,function(a){var b={};if(a.featureCollection&&"CSV"!==a.type)!0===a.featureCollection.showLegend&&h.forEach(a.featureCollection.layers,function(c){if(!1!==c.showLegend){var d=c.layerObject.renderer;b={layer:c.layerObject,title:a.title,defaultSymbol:d&&d.defaultSymbol&&d.defaultLabel?
!0:!1};1<a.featureCollection.layers.length&&(b.title+=" - "+c.layerDefinition.name);e.push(b)}});else if(a.baseMapLayer&&!0===a.showLegend&&a.layerObject||!a.baseMapLayer&&!1!==a.showLegend&&a.layerObject&&!(a.layerObject instanceof w&&a.layerObject.mode===w.MODE_SELECTION)){var c=a.layerObject.renderer,d=a.layerObject.declaredClass,c=!c||c&&c.defaultSymbol&&c.defaultLabel?!0:!1;if(10.1>a.layerObject.version&&("esri.layers.ArcGISDynamicMapServiceLayer"===d||"esri.layers.ArcGISTiledMapServiceLayer"===
d)||"esri.layers.ArcGISImageServiceLayer"===d)c=!0;b={layer:a.layerObject,title:a.title,defaultSymbol:c};a.layers&&(d=h.map(h.filter(a.layers,function(a){return!1===a.showLegend}),function(a){return a.id}),d.length&&(b.hideLayers=d));e.push(b)}});return e}function ob(a,e){function d(a,b){h.forEach(a,function(a,c){switch(a){case "../layers/ArcGISDynamicMapServiceLayer":sa=b[c];break;case "../layers/ArcGISImageServiceLayer":za=b[c];break;case "../layers/ArcGISImageServiceVectorLayer":ya=b[c];break;
case "./csv":Ja=b[c];break;case "../layers/CSVLayer":Ka=b[c];break;case "../layers/DynamicLayerInfo":ta=b[c];break;case "../layers/GeoRSSLayer":Ia=b[c];break;case "../layers/ImageParameters":ra=b[c];break;case "../layers/ImageServiceParameters":va=b[c];break;case "../layers/KMLLayer":Fa=b[c];break;case "../layers/LabelClass":Ma=b[c];break;case "../layers/LayerDrawingOptions":ua=b[c];break;case "../layers/MosaicRule":xa=b[c];break;case "../layers/OpenStreetMapLayer":Ba=b[c];break;case "../layers/RasterFunction":wa=
b[c];break;case "../layers/StreamLayer":Na=b[c];break;case "../layers/TileInfo":Ha=b[c];break;case "../layers/VectorTileLayer":P=b[c];break;case "../virtualearth/VETiledLayer":y=b[c];break;case "../layers/WebTiledLayer":Ga=b[c];break;case "../layers/WFSLayer":Ca=b[c];break;case "../layers/WMSLayer":Ea=b[c];break;case "../layers/WMSLayerInfo":Da=b[c]}})}var c=new q;a=a.itemData;e=[];a.baseMap&&a.baseMap.baseMapLayers&&(e=e.concat(a.baseMap.baseMapLayers));a.operationalLayers&&(e=e.concat(a.operationalLayers));
a=h.map(e,function(a){return a&&a.layerType});var b=[],g=[];e=!1;for(var f=0;f<a.length;f++){switch(a[f]){case "ArcGISFeatureLayer":-1===h.indexOf(b,"../layers/LabelClass")&&b.push("../layers/LabelClass");break;case "ArcGISImageServiceLayer":case "ArcGISTiledImageServiceLayer":-1===h.indexOf(b,"../layers/ArcGISImageServiceLayer")&&(b.push("../layers/ArcGISImageServiceLayer"),g.push("../layers/ImageServiceParameters"),g.push("../layers/MosaicRule"),g.push("../layers/RasterFunction"));break;case "ArcGISImageServiceVectorLayer":-1===
h.indexOf(b,"../layers/ArcGISImageServiceVectorLayer")&&(b.push("../layers/ArcGISImageServiceVectorLayer"),g.push("../layers/ImageServiceParameters"),g.push("../layers/MosaicRule"),g.push("../layers/RasterFunction"));break;case "ArcGISMapServiceLayer":case "ArcGISTiledMapServiceLayer":-1===h.indexOf(b,"../layers/ArcGISDynamicMapServiceLayer")&&(b.push("../layers/ArcGISDynamicMapServiceLayer"),g.push("../layers/DynamicLayerInfo"),g.push("../layers/ImageParameters"),g.push("../layers/LayerDrawingOptions"));
break;case "ArcGISStreamLayer":-1===h.indexOf(b,"../layers/StreamLayer")&&b.push("../layers/StreamLayer");break;case "BingMapsAerial":case "BingMapsHybrid":case "BingMapsRoad":-1===h.indexOf(b,"../virtualearth/VETiledLayer")&&b.push("../virtualearth/VETiledLayer");break;case "CSV":-1===h.indexOf(b,"../layers/CSVLayer")&&(b.push("../layers/CSVLayer"),g.push("./csv"));break;case "GeoRSS":-1===h.indexOf(b,"../layers/GeoRSSLayer")&&b.push("../layers/GeoRSSLayer");break;case "KML":-1===h.indexOf(b,"../layers/KMLLayer")&&
b.push("../layers/KMLLayer");break;case "OpenStreetMap":-1===h.indexOf(b,"../layers/OpenStreetMapLayer")&&b.push("../layers/OpenStreetMapLayer");break;case "VectorTileLayer":-1===h.indexOf(b,"../layers/VectorTileLayer")&&b.push("../layers/VectorTileLayer");break;case "WebTiledLayer":-1===h.indexOf(b,"../layers/WebTiledLayer")&&(b.push("../layers/WebTiledLayer"),g.push("../layers/TileInfo"));break;case "WFS":-1===h.indexOf(b,"../layers/WFSLayer")&&b.push("../layers/WFSLayer");break;case "WMS":-1===
h.indexOf(b,"../layers/WMSLayer")&&(b.push("../layers/WMSLayer"),g.push("../layers/WMSLayerInfo"));break;default:e=!0}if(e)break}e&&(b=pb,g=qb);b.length?J(b,function(){d(b,arguments);g.length?J(g,function(){d(g,arguments);c.resolve()}):c.resolve()}):c.resolve();return c}function $a(a,e,d,c){var b=c.itemData;b.baseMap&&b.baseMap.baseMapLayers&&b.baseMap.baseMapLayers.length&&(b.baseMap.baseMapLayers[0].firstLayer=!0);var g=e.layerMixins,f=g&&g.length;if(f){var k=function(a){for(var b=0;b<f;b++){var c=
g[b];if(c.mixin)if(c.hasOwnProperty("id")){if(a.id===c.id){m.mixin(a,c.mixin);break}}else if(a.url===c.url){m.mixin(a,c.mixin);break}}};h.forEach(b.baseMap&&b.baseMap.baseMapLayers,k);h.forEach(b.operationalLayers,k)}ob(c,e).then(function(){return kb(c,e)}).then(function(){return jb(c,e)}).then(function(b){var c=b[0],e=b[1];if(c.itemData.operationalLayers&&0!==c.itemData.operationalLayers.length){var f=new q,g=c.itemData.baseMap.baseMapLayers.slice(),k=h.filter(c.itemData.baseMap.baseMapLayers,function(a){return!a.isReference});
b={item:c.item,itemData:{baseMap:{baseMapLayers:k}}};c.itemData.baseMap.baseMapLayers=h.filter(c.itemData.baseMap.baseMapLayers,function(a){return a.isReference});M(b,e).addCallback(function(b){Q(b.itemData,e).addCallback(m.hitch(null,T,b,a,e,f))});f.then(function(a){M(c,e).addCallback(function(b){Q(b.itemData,e,a.map.spatialReference,k,a.map).addCallback(function(c){b.itemData.baseMap.baseMapLayers=g;T(b,a,e,d,c)})})},m.hitch(d,d.errback))}else M(c,e).addCallback(function(b){Q(b.itemData,e).addCallback(m.hitch(null,
T,b,a,e,d))})})}function ba(a,e){"undefined"===typeof e&&(e=!0);r._arcgisUrl&&0<r._arcgisUrl.length&&(r.arcgisUrl=r._arcgisUrl);var d=r.arcgisUrl+"/"+a,c={},b=new q;C({url:d,content:{f:"json"},callbackParamName:"callback",load:function(a){c.item=a;e?C({url:d+"/data",content:{f:"json"},callbackParamName:"callback",load:function(a){c.itemData=a;b.callback(c)},error:function(a){b.errback(a)}}):b.callback(c)},error:function(a){b.errback(a)}});return b}var r,sa,za,ya,Ja,Ka,ta,Ia,ra,va,Fa,Ma,ua,xa,Ba,wa,
Na,Ha,P,y,Ga,Ca,Ea,Da,pb="../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/CSVLayer ../layers/GeoRSSLayer ../layers/KMLLayer ../layers/LabelClass ../layers/OpenStreetMapLayer ../layers/StreamLayer ../layers/VectorTileLayer ../virtualearth/VETiledLayer ../layers/WebTiledLayer ../layers/WFSLayer ../layers/WMSLayer".split(" "),qb="./csv ../layers/DynamicLayerInfo ../layers/ImageParameters ../layers/ImageServiceParameters ../layers/LayerDrawingOptions ../layers/MosaicRule ../layers/RasterFunction ../layers/TileInfo ../layers/WMSLayerInfo".split(" ");
r={arcgisUrl:V.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:ba,createMap:function(a,e,d){var c=new q;d=d||{};var b=d.infoTemplateClass;d._clazz=b&&(m.isObject(b)?b:m.getObject(b))||W;m.isString(a)?ba(a).addCallback(m.hitch(null,$a,e,d,c)).addErrback(m.hitch(c,c.errback)):$a(e,d,c,a);c.addCallback(function(a){var b=a.map;b&&(b.tables=m.getObject("itemInfo.itemData.tables",!1,a)||[])});return c},getLayerList:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?
nb(a.itemInfo.itemData):[]},getLegendLayers:function(a){return a&&a.itemInfo&&a.itemInfo.itemData?Za(a.itemInfo.itemData):[]},_arcgisUrl:null,_getItemProps:M,_getItemData:H,_getBingKey:Y,_portalUrlResponse:aa,_portalUrlFailure:N,_processFSItemProperties:Z,_processSSItemProperties:ma,_getLayers:Q,_preBuildLayerObjects:Oa,_buildLayerObjects:ha,_preCreateMap:T,_getMapSR:ia,_createMap:z,_addSelectionLayers:Va,_createSelectionFeatureLayers:S,_getServiceInfo:Pa,_getFeatureCollectionItem:Qa,_mergeFeatureCollectionItem:Ra,
_projectFeatureCollection:Sa,_getLayersInfo:Ua,_initLayer:Aa,_loadAsCached:da,_loadAsDynamic:qa,_processPopups:ca,_onLayersAddResult:Wa,_sameSpatialReferenceAsBasemap:fa,_sameTilingSchemeAsBasemap:ga,_showPopup:ja,_calculateClickTolerance:Xa,_getVisibleFeatureLayers:ea,_updateLayerScaleInfo:R,_checkUrl:A,_isHostedService:oa,_isAgolService:pa,_getLegendLayers:Za};m.setObject("arcgis.utils",r,B);return r});