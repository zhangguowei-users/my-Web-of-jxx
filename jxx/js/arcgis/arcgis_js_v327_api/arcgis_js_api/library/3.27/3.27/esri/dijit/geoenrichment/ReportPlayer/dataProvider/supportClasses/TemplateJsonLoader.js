// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/TemplateJsonLoader","dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all ./CustomReportsManager ./GenericTemplateGenerator ./dataCollections/DataCollectionsLoader ../../core/conversion/PortalToEditorConverter ../../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider ../../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../core/conversion/portalToEditorUtils/parsers/_FieldInfoBuilder".split(" "),
function(k,r,l,t,u,v,m,w,n,x,g,y){var p={_templatesCache:{},getCachedTemplateJson:function(a,b){return(a=this._templatesCache[a+";"+b.reportID])&&a.modified===b.modified?{templateJson:k.clone(a.templateJsonInfo.templateJson),templateVariableProvider:a.templateJsonInfo.templateVariableProvider}:null},putCachedTemplateJson:function(a,b,d){this._templatesCache[a+";"+d.reportID]={modified:d.modified,templateJsonInfo:{templateJson:k.clone(b.templateJson),templateVariableProvider:b.templateVariableProvider}}}};
return{getTemplateJsonByID:function(a,b){var d=this,f=new r;l(u.getCustomReportByID(a),function(c){if(c){var e=b&&p.getCachedTemplateJson(a.countryID,c);if(e)f.resolve(e);else{var e=[d._loadCustomReportData(c)],q;"US"!==a.countryID&&"CA"!==a.countryID&&(q=!0,e.push(m.loadVariables({countryID:a.countryID,hierarchy:c.hierarchy,outFields:["description"]})));return t(e).then(function(e){var d=new n;return l(w.provideEditorJson(c,{variableProvider:d}),function(){var h=c.templateJson;if(q){var g=e[1].idToVariableCache,
k=e[1].fullNameToVariableCache;x.processTemplateFieldInfos(h,function(a){if(a.hasVariable&&a.variableID){var c=k[a.fullName]||g[a.variableID];a.alias=c&&c.description||a.alias;c&&c.description||console.log("Can't find variable with ID: "+a.variableID)}})}c.portalJson=null;c.templateJson=null;h={templateJson:h,templateVariableProvider:d};b&&p.putCachedTemplateJson(a.countryID,h,c);f.resolve(h)})})}}else f.reject("Can't find a report")},f.reject);return f.promise},_loadCustomReportData:function(a){a.portalJson=
null;return a.templateData.getFiles().then(function(b){a.portalJson={files:b}})},createTemplateJsonFromVariables:function(a){return m.loadVariables({countryID:a.countryID,hierarchy:a.hierarchy,outFields:["description","precision","type","vintage"],forceLowerCase:!0}).then(function(b){var d=new n,f=b.fullNameToVariableCache;b=a.variables.map(function(a){a=a.toLowerCase();var b=f[a],c=g.createFieldNameFromVariable(a);a={id:b.id.toLowerCase(),fullName:a,alias:b.description,fieldName:c,precision:b.precision,
calculatorName:g.DATA_COLLECTIONS_CALCULATOR_NAME,templateName:g.DATA_COLLECTIONS_CALCULATOR_NAME+"."+c,type:b.type,vintage:b.vintage};d.addVariable(a);return y.getCalculatorOrScriptFieldInfo(a.templateName,{variableProvider:d})});return{templateJson:v.generateTemplatesFromFieldInfos(b,{comparisonLevels:a.comparisonLevels}),templateVariableProvider:d}})}}});