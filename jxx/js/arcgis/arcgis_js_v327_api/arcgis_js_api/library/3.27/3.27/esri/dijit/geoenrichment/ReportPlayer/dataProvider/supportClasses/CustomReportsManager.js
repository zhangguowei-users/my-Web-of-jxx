// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/CustomReportsManager","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when esri/kernel ./PortalManager ./ReportTemplateData ./StandardGraphicReportTemplates esri/dijit/geoenrichment/utils/PortalQueryUtil ../../_devConfig".split(" "),function(e,g,k,f,l,h,m,n,p,q){var r=e(null,{cache:null,constructor:function(){this.cache={}}});e={TEMPLATE_TYPE:"Report Template",PLAYER_STANDARD_INFOGRAPHIC_TYPEKEYWORD:"esriReportPlayerStandardInfographic",
_reportsCache:null,resetCache:function(){this._reportsCache=new r},getCustomReports:function(a){var c=this;return f(h.getPortalInfo(a.portalUrl),function(b){var d=b.user.username,d={num:1E3,start:1,q:p.combineQueryString({type:"Report Template",typeKeywords:a.typeKeywords,owner:!a.publicOnly&&d}),sortField:"modified",sortOrder:"desc"};return b.portal.queryItems(d).then(function(d){d=d.results.map(function(a){return c._prepareCustomReportFromItem(a,b.portal)});return c._getCountryReports(d,a.countryID)})})},
_getCountryReports:function(a,c){return a&&a.filter(function(a){return!a.countries||a.countries.split(",").some(function(a){return c===a.trim()})})},_prepareCustomReportFromItem:function(a,c){var b=g.mixin({},a.properties||a.details);b.isGraphicReport="true"===b.isGraphicReport;b.isMultiFeature="true"===b.isMultiFeature;b.reportID=a.id;a={title:a.title,templateData:new m(a,c),modified:a.modified.getTime()};g.mixin(a,b);return a},getCustomReportByID:function(a){var c=this,b=this._reportsCache.cache[a.reportID];
return b?b:this._reportsCache.cache[a.reportID]=f(h.getPortalInfo(a.portalUrl),function(b){return b.user.getItem(a.reportID).then(function(a){return a&&c._prepareCustomReportFromItem(a,b.portal)})}).otherwise(function(b){delete c._reportsCache.cache[a.reportID];return a.ignoreError?null:(new k).reject(b)})},tryFindReportIdByAlias:function(a){var c=this,b=n.aliasToID(a.countryID,a.reportID);return b?f(this.getCustomReportByID({reportID:b,portalUrl:a.portalUrl,ignoreError:!0}),function(b){return b?
b.reportID:f(c.getCustomReports({portalUrl:a.portalUrl,countryID:a.countryID,typeKeywords:"esriReportPlayerStandardInfographic",publicOnly:!0},!0),function(b){return(b=b.filter(function(b){var c;if(c=b.playerAlias===a.reportID)c=b.jsapiVersion,b=(q.jsapiVersion||l.version).split("."),c=c.split("."),c=Number(b[0])<Number(c[0])?!1:Number(b[1])>=Number(c[1]);return c})[0])&&b.reportID})}):null},itemUpdated:function(a){delete this._reportsCache.cache[a]},getFakeCustomReportByContext:function(a){return{title:"Generic template",
type:"esriReportTemplateStandard",coverage:a.countryID,countries:a.countryID,hierarchy:a.hierarchy||"census",isGraphicReport:!0,isMultiFeature:!1,reportID:null}}};e.resetCache();return e});