// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.27/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/ReportDataProcessor","dojo/when dojo/promise/all dojo/Deferred ./tasks/EnrichAreasTask ./tasks/RunReportTask ./AreaDataUtil ./AreaCalculatorsUtil ./CustomReportsManager ./attachments/AttributesUtil esri/dijit/geoenrichment/utils/DateUtil ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary ../../core/infographics/simpleInfographic/dataDrilling/EnrichUtil ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../core/infographics/utils/InfographicJsonUtil".split(" "),
function(g,k,l,m,r,t,e,n,u,p,q,v,h,w){return{populateReportDataFromAttachmentsStore:function(b,a){var c=[];a.setCurrentAnalysisAreaIndex&&a.setCurrentAnalysisAreaIndex(0);c.push(g(a.getNotes(),function(a){a&&a.length&&(b.fieldData.metadata[q.SITENOTE_FIELD_NAME]=a[0].text,b.fieldData.metadata[q.SITENOTES_FIELD_NAME]=a.map(function(a){return a.text}).join("\x3cbr/\x3e\x3cbr/\x3e"))}));c.push(g(a.getAttributes(),function(a){if(!a||!a.length)return null;var c={attributes:{}};a.forEach(function(a){c.attributes[a.name]=
u.formatAttributeValue(a)});b.analysisAreas.forEach(function(a,d){(a=b.fieldData.areaData[d])&&e.addFeatureAttributesCalculator(c,a)})}));return k(c)},runReportAndGetData:function(b){return g(n.getCustomReportByID(b),function(a){return(new r).execute({analysisAreas:b.analysisAreas,countryID:b.countryID,hierarchy:a.hierarchy,report:{reportID:a.reportID,portalUrl:a.templateData.getPortalUrl(!0),modified:a.modified},cacheResult:!0}).then(function(c){return{taskID:c.taskID,selectedReport:a,areaData:c.areaData}},
function(a){b.fieldData.errors.push(a);return(new l).reject(a)})})},runReportFromVariables:function(b){var a={};b.variables.forEach(function(b){b=b.toLowerCase();var c=h.createFieldNameFromVariable(b);a[b.substr(b.indexOf(".")+1)]=c});return(new m).enrichAreas({analysisAreas:b.analysisAreas,countryID:b.countryID,hierarchy:b.hierarchy,fields:b.variables,comparisonLevels:b.comparisonLevels||w.getDefaultLevels()}).then(function(c){var d=b.analysisAreas.map(function(){return{}});e.addEnrichFeatures(c,
a,h.DATA_COLLECTIONS_CALCULATOR_NAME,d);return{areaData:d}},function(a){b.fieldData.errors.push(a);return(new l).reject(a)})},applyRunReportAndGetDataResults:function(b,a){b&&b.areaData&&(a.fieldData.runReportTaskID=b.taskID,a.fieldData.areaData=b.areaData,a.analysisAreas&&this._reportDataFromAreas(a.analysisAreas,a.fieldData.areaData),b.selectedReport&&this._reportDataFromReport(b.selectedReport,a.fieldData,a.combinedAreasInfo))},_reportDataFromAreas:function(b,a){b.forEach(function(b,d){if(d=a[d])e.addFeatureAttributesCalculator(b.feature,
d),e.addAreaInfoCalculator(b,d)})},_reportDataFromReport:function(b,a,c){a=a.metadata;b&&!a.Title&&(a.Title=b.title);a.Source="Esri";a.Date=p.getReportFooterDate();a.Copyright="\u00a9"+p.getFullYear()+" Esri";a.ProductLabel="";a.ProductUrl="";a.PhoneNumber="";a.TrialUrlText="";b.isMultiFeature&&(a.SITE_NAME=c.locationName||c.name,a.STORE_NAME=c.locationName||c.name,a.AREA_DESC2=c.description||c.name,a.STORE_ADDR=c.address)},enrichFieldData:function(b,a){function c(b,c,d){function x(b){return a.fieldData.areaData.every(function(c,
f){return void 0!==t.getAreaDataValue({fieldName:b,fieldData:a.fieldData,calculatorName:d,featureIndex:f,ignoreMetadata:!0})})}d=d||h.ENRICHED_DATA_NO_LEVELS;var f=[],e={};b.forEach(function(a){x(a.fieldName)||(f.push(a.mapTo),e[a.mapTo]=a.fieldName,e[a.mapTo.substr(a.mapTo.indexOf(".")+1)]=a.fieldName)});return f.length?{fields:f,fieldsMap:e,comparisonLevels:c,calculatorName:d}:null}var d=[];b=v.optimizeInfos(b);b.forEach(function(a){var b;if(a.isGeneral||a.isChart)b=c(a.fields,a.levels,a.calculatorName);
b&&d.push(b)});if(d.length)return g(n.getCustomReportByID(a),function(b){function c(b){a.fieldData.errors.push(b)}return k(d.map(function(d){return(new m).enrichAreas({analysisAreas:a.analysisAreas,countryID:a.countryID,hierarchy:b.hierarchy,fields:d.fields,comparisonLevels:d.comparisonLevels}).then(function(b){e.addEnrichFeatures(b,d.fieldsMap,d.calculatorName,a.fieldData.areaData)},c)}))})}}});